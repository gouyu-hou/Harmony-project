import router from '@ohos.router';
import CoffeeApi, { ProductItem } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct MyFavoritePage {
  @StorageLink('token') token: string = '';

  // æ”¶è—åˆ—è¡¨æ•°æ®
  @State favoriteList: ProductItem[] = [];

  // é¡µé¢æ˜¾ç¤ºæ—¶æ‹‰å–æ•°æ®
  onPageShow() {
    this.fetchFavorites();
  }

  async fetchFavorites() {
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      return;
    }
    try {
      const res = await CoffeeApi.findAllLike(this.token);
      if (res.code === 200 && res.data) {
        this.favoriteList = res.data;
      } else {
        // å¦‚æœæ²¡æœ‰æ•°æ®æˆ– code ä¸å¯¹ï¼Œæ¸…ç©ºåˆ—è¡¨
        this.favoriteList = [];
      }
    } catch (err) {
      console.error('è·å–æ”¶è—åˆ—è¡¨å¤±è´¥');
    }
  }

  // å–æ¶ˆæ”¶è—
  async handleRemove(pid: string) {
    try {
      const res = await CoffeeApi.notLike(this.token, pid);
      if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
        promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
        // é‡æ–°æ‹‰å–åˆ—è¡¨åˆ·æ–°
        this.fetchFavorites();
      } else {
        promptAction.showToast({ message: res.msg || 'æ“ä½œå¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Text('< è¿”å›').fontSize(16).fontColor('#0035AA').onClick(() => router.back())
        Text('æˆ‘çš„æ”¶è—').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
      }
      .width('100%').height(50).padding({ left: 15, right: 15 }).backgroundColor(Color.White)

      // åˆ—è¡¨åŒºåŸŸ
      if (this.favoriteList.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('æš‚æ— æ”¶è—å•†å“').fontSize(16).fontColor('#999').margin({ top: 100 })
        }.width('100%').layoutWeight(1)
      } else {
        List({ space: 10 }) {
          ForEach(this.favoriteList, (item: ProductItem) => {
            ListItem() {
              Row() {
                // å•†å“å›¾ç‰‡
                Image(item.smallImg)
                  .width(80).height(80).objectFit(ImageFit.Cover)
                  .borderRadius(8).backgroundColor('#F5F5F5')
                  .margin({ right: 10 })

                // å•†å“ä¿¡æ¯
                Column() {
                  Text(item.name).fontSize(16).fontWeight(FontWeight.Bold).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                  Text(item.enname).fontSize(12).fontColor('#999').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).margin({ top: 4 })
                  Blank()
                  Text(`Â¥${item.price}`).fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)
                }
                .layoutWeight(1).height(80).alignItems(HorizontalAlign.Start)
                .onClick(() => {
                  // ç‚¹å‡»è·³è½¬è¯¦æƒ…é¡µ
                  router.pushUrl({ url: 'pages/ProductDetailPage', params: { pid: item.pid } })
                })

                // åˆ é™¤æŒ‰é’®
                Column() {
                  Text('ğŸ—‘ï¸') // è¿™é‡Œå¯ä»¥ç”¨å›¾ç‰‡ä»£æ›¿
                    .fontSize(20)
                    .fontColor('#999')
                    .padding(10)
                    .onClick(() => {
                      // å¼¹çª—ç¡®è®¤
                      AlertDialog.show({
                        title: 'æç¤º',
                        message: 'ç¡®å®šå–æ¶ˆæ”¶è—è¯¥å•†å“å—ï¼Ÿ',
                        primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
                        secondaryButton: {
                          value: 'ç¡®å®š',
                          fontColor: 'red',
                          action: () => this.handleRemove(item.pid)
                        }
                      })
                    })
                }.height(80).justifyContent(FlexAlign.Center)

              }
              .width('100%').padding(10).backgroundColor(Color.White).borderRadius(8)
            }
          })
        }
        .width('100%').layoutWeight(1).padding(10)
      }
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }
}