import router from '@ohos.router';
import CoffeeApi, { OrderItem, OrderProduct,ApiResponse, ShopCartItem } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct MyOrderPage {
  @StorageLink('token') token: string = '';
  // 0=å…¨éƒ¨, 1=è¿›è¡Œä¸­, 2=å·²å®Œæˆ
  @State currentStatus: number = 0;
  @State orderList: OrderItem[] = [];
  @State isLoading: boolean = false;

  // âœ… å¿…é¡»å®šä¹‰è¿™ä¸ªï¼Œå¦åˆ™ handleDelete é‡Œçš„ this.cartList ä¼šæŠ¥é”™
  @State cartList: ShopCartItem[] = [];
  @State totalPrice: number = 0;

  // âœ… å¿…é¡»å®šä¹‰è¿™ä¸ªï¼Œå¦åˆ™ handleDelete é‡Œçš„ this.calculateTotal() ä¼šæŠ¥é”™
  calculateTotal() {
    let total = 0;
    this.cartList.forEach((item) => {
      total += item.price * item.count;
    });
    this.totalPrice = total;
  }

  tabs: string[] = ['å…¨éƒ¨', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'];

  onPageShow() {
    this.fetchOrders();
  }

  async fetchOrders() {
    if (!this.token) return;
    this.isLoading = true;
    this.orderList = [];
    try {
      const res = await CoffeeApi.findOrder(this.token, this.currentStatus);
      if (res.code === 200 && res.result) {
        this.orderList = Array.isArray(res.result) ? res.result : [];
      }
    } catch (err) {
      console.error('è·å–è®¢å•å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  async handleReceive(oid: string) {
    try {
      const res = await CoffeeApi.receiveOrder(this.token, oid);
      if (res.code === 200 || res.code === 'B001') {
        promptAction.showToast({ message: 'ç¡®è®¤æ”¶è´§æˆåŠŸ' });
        this.fetchOrders();
      } else {
        promptAction.showToast({ message: res.msg || 'æ“ä½œå¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  async handleDelete(sid: string) {
    try {
      const res: ApiResponse<null> = await CoffeeApi.deleteShopcart(this.token, [sid]);
      if (res.code === 6000 || res.code === 200 || res.code === '200') {

        // âœ… æ ¸å¿ƒä¿®å¤ï¼š
        const newList = this.cartList.filter(item => item.sid !== sid);
        // å…ˆç½®ç©ºå†èµ‹å€¼ï¼Œè¿™æ˜¯ ArkUI å¼ºåˆ¶åˆ·æ–°çš„â€œå¤§æ‹›â€
        this.cartList = [];
        this.cartList = newList;

        this.calculateTotal();
        promptAction.showToast({ message: 'å·²åˆ é™¤' });
      } else {
        promptAction.showToast({ message: res.msg || 'åˆ é™¤å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'åˆ é™¤å¼‚å¸¸' });
    }
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆª
      Stack({ alignContent: Alignment.Top }) {
        Column().width('100%').height(100).backgroundColor('#0035AA')
        Row() {
          Text('< è¿”å›').fontSize(16).fontColor(Color.White).onClick(() => router.back())
          Text('æˆ‘çš„è®¢å•').fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White)
            .layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
        }
        .width('100%').height(50).padding({ left: 15, right: 15 })
      }.height(60).width('100%')

      // 2. Tab æ 
      Column() {
        Row() {
          ForEach(this.tabs, (item: string, index: number) => {
            Column() {
              Text(item)
                .fontSize(14)
                .fontColor(this.currentStatus === index ? '#0035AA' : '#666')
                .fontWeight(this.currentStatus === index ? FontWeight.Bold : FontWeight.Normal)
                .margin({ bottom: 8 })
              if (this.currentStatus === index) {
                Divider().width(20).strokeWidth(3).color('#0035AA').borderRadius(2)
              } else {
                Divider().width(20).strokeWidth(3).color(Color.Transparent)
              }
            }
            .layoutWeight(1).height(40).justifyContent(FlexAlign.End)
            .onClick(() => {
              if (this.currentStatus !== index) {
                this.currentStatus = index;
                this.fetchOrders();
              }
            })
          })
        }.width('100%').border({ width: { bottom: 1 }, color: '#F5F5F5' })

        // 3. è®¢å•åˆ—è¡¨
        if (this.isLoading) {
          Column() { LoadingProgress().width(40).height(40).color('#0035AA') }
          .layoutWeight(1).justifyContent(FlexAlign.Center)
        } else if (this.orderList.length === 0) {
          Column() {
            Text('ğŸ“¦').fontSize(50).margin({ bottom: 10 })
            Text('æš‚æ— è®¢å•').fontSize(14).fontColor('#999')
          }.layoutWeight(1).justifyContent(FlexAlign.Center)
        } else {
          List({ space: 15 }) {
            ForEach(this.orderList, (order: OrderItem) => {
              ListItem() {
                this.OrderCard(order)
              }
            }, (item: OrderItem) => item.oid)
          }
          .layoutWeight(1).width('100%').padding(15)
        }
      }
      .layoutWeight(1).width('100%').backgroundColor(Color.White)
      .borderRadius({ topLeft: 12, topRight: 12 }).margin({ top: -10 })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  @Builder OrderCard(order: OrderItem) {
    Column() {
      // å¤´éƒ¨
      Row() {
        Text(order.oid).fontSize(12).fontColor('#999')
        Text(order.status === 2 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­')
          .fontSize(14).fontColor(order.status === 2 ? '#999' : '#D22028')
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 10 })

      Divider().color('#F5F5F5')

      // å•†å“åˆ—è¡¨
      Column({ space: 10 }) {
        ForEach(order.products, (prod: OrderProduct) => {
          Row() {
            Image(prod.smallImg).width(60).height(60).borderRadius(4).backgroundColor('#F5F5F5')
            Column() {
              Text(prod.name).fontSize(14).fontWeight(FontWeight.Bold).maxLines(1)
              Text(prod.rule).fontSize(12).fontColor('#999').margin({ top: 4 })
            }.layoutWeight(1).alignItems(HorizontalAlign.Start).margin({ left: 10 })
            Column() {
              Text(`Â¥${prod.price}`).fontSize(14).fontColor('#333')
              Text(`x${prod.count}`).fontSize(12).fontColor('#999').margin({ top: 4 })
            }.alignItems(HorizontalAlign.End)
          }.width('100%').padding({ top: 10, bottom: 10 })
        }, (p: OrderProduct, i: number) => `${p.pid}_${i}`)
      }

      Divider().color('#F5F5F5')

      // åº•éƒ¨
      Row() {
        Text(order.date).fontSize(12).fontColor('#CCC')
        Blank()
        Text(`æ€»è®¡ Â¥${order.amount}`).fontSize(14).fontWeight(FontWeight.Bold).margin({ right: 10 })

        if (order.status === 1) {
          // âœ… ä¿®å¤ç‚¹ï¼šä½¿ç”¨ Normal ç±»å‹å¹¶æ‰‹åŠ¨è®¾ç½®åœ†è§’
          Button('ç¡®è®¤æ”¶è´§', { type: ButtonType.Normal })
            .borderRadius(14)
            .backgroundColor('#0035AA').fontSize(12).height(28)
            .onClick(() => this.handleReceive(order.oid))
        } else {
          // âœ… ä¿®å¤ç‚¹ï¼šä½¿ç”¨ Normal ç±»å‹å¹¶æ‰‹åŠ¨è®¾ç½®åœ†è§’
          Button('åˆ é™¤è®¢å•', { type: ButtonType.Normal })
            .borderRadius(14)
            .backgroundColor(Color.White).fontColor('#999').fontSize(12).height(28)
            .border({ width: 1, color: '#EEE' })
            .onClick(() => {
              AlertDialog.show({
                title: 'æç¤º',
                message: 'ç¡®è®¤åˆ é™¤æ­¤è®¢å•ï¼Ÿ',
                primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
                secondaryButton: { value: 'åˆ é™¤', fontColor: 'red', action: () => this.handleDelete(order.oid) }
              })
            })
        }
      }.width('100%').margin({ top: 10 }).alignItems(VerticalAlign.Center)
    }
    .width('100%').padding(15).backgroundColor(Color.White).borderRadius(8)
    .shadow({ radius: 5, color: '#0D000000', offsetY: 2 })
  }
}