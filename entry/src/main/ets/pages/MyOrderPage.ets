import router from '@ohos.router';
import CoffeeApi, { OrderItem, OrderProduct } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

// 1. å®šä¹‰åç«¯æ•°æ®åº“åŸå§‹ç»“æ„
interface RawDbOrder {
  id: number;
  oid: string;
  pid: string;
  name: string;
  price: string;
  smallImg: string;
  count: number;
  rule: string;
  status: number;
  createdAt: string;
  updatedAt: string;
  address: string;
  phone: string;
  receiver: string;
  userId: string;
}

// åŸºç¡€å“åº”æ¥å£
interface BasicResponse {
  code: number | string;
  msg?: string;
  data?: Object;
  result?: Object;
}

@Entry
@Component
struct MyOrderPage {
  @StorageLink('token') token: string = '';

  @State currentStatus: number = 0; // 0:å…¨éƒ¨, 1:è¿›è¡Œä¸­, 2:å·²å®Œæˆ
  @State orderList: OrderItem[] = [];
  @State isLoading: boolean = false;

  aboutToAppear() {
    this.fetchOrders(this.currentStatus);
  }

  // 2. æ•°æ®æ¸…æ´—å‡½æ•° (å·²ä¿®å¤å­—é¢é‡ç±»å‹æŠ¥é”™)
  normalizeOrderData(flatList: RawDbOrder[]): OrderItem[] {
    const orderMap = new Map<string, OrderItem>();

    flatList.forEach((item) => {
      if (!orderMap.has(item.oid)) {
        // æ˜¾å¼å£°æ˜ç±»å‹ï¼Œè§£å†³ arkts-no-untyped-obj-literals
        const newOrder: OrderItem = {
          oid: item.oid,
          status: item.status,
          date: item.createdAt || item.updatedAt,
          amount: 0,
          address: item.address,
          products: []
        };
        orderMap.set(item.oid, newOrder);
      }

      const order = orderMap.get(item.oid);

      if (order) {
        const unitPrice = parseFloat(item.price);
        const itemTotalPrice = unitPrice * item.count;
        order.amount += itemTotalPrice;

        // æ˜¾å¼å£°æ˜ç±»å‹
        const product: OrderProduct = {
          pid: item.pid,
          name: item.name,
          smallImg: item.smallImg,
          price: unitPrice,
          count: item.count,
          rule: item.rule
        };
        order.products.push(product);
      }
    });

    const result = Array.from(orderMap.values());
    result.forEach(order => {
      order.amount = parseFloat(order.amount.toFixed(2));
    });

    return result.sort((a, b) => {
      const timeA = new Date(a.date).getTime();
      const timeB = new Date(b.date).getTime();
      return timeB - timeA;
    });
  }

  // 3. æå–è®¢å•æ•°ç»„
  findOrderArrayInObject(obj: Object): RawDbOrder[] | null {
    if (!obj) return null;
    const root = obj as Record<string, Object>;

    if (root['result'] && Array.isArray(root['result'])) {
      return root['result'] as RawDbOrder[];
    }
    if (root['data']) {
      let dataObj = root['data'];
      if (typeof dataObj === 'string') {
        try { dataObj = JSON.parse(dataObj); } catch (e) {}
      }
      const innerData = dataObj as Record<string, Object>;
      if (innerData && innerData['result'] && Array.isArray(innerData['result'])) {
        return innerData['result'] as RawDbOrder[];
      }
      if (Array.isArray(dataObj)) {
        return dataObj as RawDbOrder[];
      }
    }
    if (root['result']) {
      let resultObj = root['result'];
      if (typeof resultObj === 'string') {
        try { resultObj = JSON.parse(resultObj); } catch (e) {}
      }
      const innerResult = resultObj as Record<string, Object>;
      if (innerResult && innerResult['result'] && Array.isArray(innerResult['result'])) {
        return innerResult['result'] as RawDbOrder[];
      }
    }
    return null;
  }

  async fetchOrders(status: number) {
    this.isLoading = true;
    this.orderList = [];

    try {
      const rawRes = await CoffeeApi.findOrder(this.token, status);
      const targetList = this.findOrderArrayInObject(rawRes as Object);

      if (targetList && targetList.length > 0) {
        this.orderList = this.normalizeOrderData(targetList);
      } else {
        this.orderList = [];
      }
    } catch (err) {
      console.error('[MyOrderPage] Error:', JSON.stringify(err as Object));
      promptAction.showToast({ message: 'è·å–è®¢å•å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // âœ… æ ¸å¿ƒä¿®å¤ï¼šåˆ é™¤è®¢å•é€»è¾‘
  async handleDelete(oid: string) {
    try {
      const res = await CoffeeApi.removeOrder(this.token, oid);
      const response = res as Object as BasicResponse;
      const code = response.code;

      if (code == 200 || code == '200' || code == 70000 || code == '70000') {

        // ğŸ”¥ 1. æ‰¾åˆ°ç´¢å¼•
        const index = this.orderList.findIndex(item => item.oid === oid);
        if (index !== -1) {
          // ğŸ”¥ 2. ä½¿ç”¨ splice ç›´æ¥ä»æ•°ç»„ä¸­ç§»é™¤
          // ç›¸æ¯” filterï¼Œsplice æ˜¯åŸåœ°å˜å¼‚æ“ä½œï¼ŒArkUI èƒ½å¤Ÿç²¾ç¡®æ•æ‰å¹¶ç«‹å³æ‰§è¡Œåˆ é™¤åŠ¨ç”»/åˆ·æ–°
          this.orderList.splice(index, 1);
        }

        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
      } else {
        promptAction.showToast({ message: response.msg || 'åˆ é™¤å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  // âœ… æ ¸å¿ƒä¿®å¤ï¼šç¡®è®¤æ”¶è´§é€»è¾‘
  async handleReceive(oid: string) {
    try {
      const res = await CoffeeApi.receiveOrder(this.token, oid);
      const response = res as Object as BasicResponse;
      const code = response.code;

      if (code == 200 || code == '200' || code == 70000 || code == '70000') {

        const index = this.orderList.findIndex(item => item.oid === oid);

        if (index !== -1) {
          if (this.currentStatus === 1) {
            // åœºæ™¯Aï¼šå¦‚æœåœ¨â€œè¿›è¡Œä¸­â€Tabï¼Œæ”¶è´§åå®ƒå°±ä¸å±äºè¿™é‡Œäº† -> ç›´æ¥ç§»é™¤
            this.orderList.splice(index, 1);
          } else {
            // åœºæ™¯Bï¼šå¦‚æœåœ¨â€œå…¨éƒ¨â€Tabï¼Œå®ƒè¿˜åœ¨åˆ—è¡¨é‡Œï¼Œä½†çŠ¶æ€å˜äº†

            // ğŸš« é¿å…ä½¿ç”¨ const newObj = { ...oldObj } (ä¸¥æ ¼æ¨¡å¼æŠ¥é”™)
            // âœ… æ‰‹åŠ¨æ„å»ºæ–°å¯¹è±¡ï¼Œåªä¿®æ”¹ status
            const oldItem = this.orderList[index];
            const newItem: OrderItem = {
              oid: oldItem.oid,
              status: 2, // çŠ¶æ€æ”¹ä¸ºå·²å®Œæˆ
              date: oldItem.date,
              amount: oldItem.amount,
              address: oldItem.address,
              products: oldItem.products
            };

            // ğŸ”¥ ä½¿ç”¨ splice(index, 1, newItem) æ›¿æ¢å…ƒç´ 
            // è¿™ä¼šå¼ºåˆ¶ UI è®¤ä¸ºè¯¥è¡Œæ•°æ®å·²æ›´æ–°ï¼Œç«‹å³é‡ç»˜æŒ‰é’®
            this.orderList.splice(index, 1, newItem);
          }
        }

        promptAction.showToast({ message: 'ç¡®è®¤æ”¶è´§æˆåŠŸ' });

      } else {
        promptAction.showToast({ message: response.msg || 'æ“ä½œå¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  @Builder OrderItemView(item: OrderItem) {
    Column() {
      // å¤´éƒ¨
      Row() {
        Text(`è®¢å•å·: ${item.oid}`)
          .fontSize(12)
          .fontColor('#999')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        Text(item.status === 2 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­')
          .fontSize(14)
          .fontColor(item.status === 2 ? '#999' : '#D22028')
          .margin({ left: 8 })
      }
      .width('100%')
      .padding({ bottom: 8 })

      Divider().color('#F5F5F5')

      // å•†å“åˆ—è¡¨
      Column() {
        ForEach(item.products, (prod: OrderProduct) => {
          Row() {
            Image(prod.smallImg)
              .width(60)
              .height(60)
              .borderRadius(4)
              .objectFit(ImageFit.Cover)
              .backgroundColor('#F5F5F5')

            Column() {
              Text(prod.name)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Text(prod.rule)
                .fontSize(12)
                .fontColor('#999')
                .margin({ top: 4 })
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
            .padding({ left: 10, right: 10 })

            Column() {
              Text(`Â¥${prod.price}`).fontSize(14).fontColor('#333')
              Text(`x${prod.count}`).fontSize(12).fontColor('#999')
            }
            .alignItems(HorizontalAlign.End)
          }
          .width('100%')
          .padding({ top: 10, bottom: 10 })
        }, (prod: OrderProduct) => `${item.oid}_${prod.pid}`)
      }
      .width('100%')

      Divider().color('#F5F5F5')

      // åº•éƒ¨ä¿¡æ¯æ 
      Column() {
        Row() {
          Text(item.date ? item.date.split('T')[0] : '')
            .fontSize(12)
            .fontColor('#999')

          Blank()

          Row() {
            Text('å…±').fontSize(12).fontColor('#999')
            Text(`${item.products.reduce((sum, p) => sum + p.count, 0)}`)
              .fontSize(12)
              .fontColor('#D22028')
              .margin({ left: 2, right: 2 })
            Text('ä»¶ åˆè®¡:').fontSize(12).fontColor('#999')
            Text(`Â¥${item.amount}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ left: 4 })
          }
        }
        .width('100%')
        .padding({ top: 8, bottom: 8 })

        Row() {
          Blank()

          // æ ¹æ® item.status åŠ¨æ€æ˜¾ç¤ºæŒ‰é’®
          if (item.status === 1) {
            Button('ç¡®è®¤æ”¶è´§', { type: ButtonType.Normal })
              .width(84)
              .height(28)
              .fontSize(12)
              .backgroundColor(Color.White)
              .fontColor('#0035AA')
              .border({ width: 1, color: '#0035AA', radius: 14 })
              .onClick(() => this.handleReceive(item.oid))
          } else if (item.status === 2) {
            Button('åˆ é™¤è®¢å•', { type: ButtonType.Normal })
              .width(84)
              .height(28)
              .fontSize(12)
              .backgroundColor(Color.White)
              .fontColor('#999')
              .border({ width: 1, color: '#CCC', radius: 14 })
              .onClick(() => {
                AlertDialog.show({
                  title: 'æç¤º',
                  message: 'ç¡®è®¤åˆ é™¤è¯¥è®¢å•å—ï¼Ÿ',
                  primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
                  secondaryButton: { value: 'åˆ é™¤', fontColor: 'red', action: () => this.handleDelete(item.oid) }
                })
              })
          }
        }
        .width('100%')
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Text('<')
          .fontSize(24)
          .fontColor('#333')
          .padding({ right: 20 })
          .onClick(() => router.back())
        Text('æˆ‘çš„è®¢å•').fontSize(18).fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .height(50)
      .padding({ left: 15 })
      .backgroundColor(Color.White)

      // Tabs
      Tabs({ index: this.currentStatus }) {
        TabContent().tabBar('å…¨éƒ¨')
        TabContent().tabBar('è¿›è¡Œä¸­')
        TabContent().tabBar('å·²å®Œæˆ')
      }
      .onChange((index: number) => {
        this.currentStatus = index;
        this.fetchOrders(index);
      })
      .barMode(BarMode.Fixed)
      .barWidth('100%')
      .barHeight(44)
      .backgroundColor(Color.White)
      .height(44)

      // è°ƒè¯•ä¿¡æ¯ (å¯åˆ )
      if (this.orderList.length > 0) {
        Text(`å·²åŠ è½½ ${this.orderList.length} ä¸ªè®¢å•`)
          .fontSize(10)
          .fontColor(Color.Gray)
          .margin({ top: 5, bottom: 5 })
      }

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40).color('#0035AA')
        }
        .layoutWeight(1)
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.orderList.length === 0) {
        Column() {
          Text('æš‚æ— ç›¸å…³è®¢å•')
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 10 })
        }
        .layoutWeight(1)
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // åˆ—è¡¨
        List({ space: 12 }) {
          // âš ï¸ ForEach Key å¿…é¡»å”¯ä¸€ä¸”ç¨³å®šï¼Œè¿™é‡Œä½¿ç”¨ item.oid
          ForEach(this.orderList, (item: OrderItem) => {
            ListItem() {
              this.OrderItemView(item)
            }
          }, (item: OrderItem) => item.oid)
        }
        .layoutWeight(1)
        .width('100%')
        .padding({ left: 12, right: 12, top: 10, bottom: 20 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}