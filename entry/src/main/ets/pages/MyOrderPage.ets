import router from '@ohos.router';
import CoffeeApi, { OrderItem, OrderProduct } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

// 1. å®šä¹‰åç«¯æ•°æ®åº“åŸå§‹ç»“æ„
interface RawDbOrder {
  id: number;
  oid: string;
  pid: string;
  name: string;
  price: string;
  smallImg: string;
  count: number;
  rule: string;
  status: number;
  createdAt: string;
  updatedAt: string;
  address: string;
  phone: string;
  receiver: string;
  userId: string;
}

@Entry
@Component
struct MyOrderPage {
  @StorageLink('token') token: string = '';

  @State currentStatus: number = 0;
  @State orderList: OrderItem[] = [];
  @State isLoading: boolean = false;

  aboutToAppear() {
    this.fetchOrders(this.currentStatus);
  }

  // 2. æ•°æ®æ¸…æ´—å‡½æ•° (ä¿æŒä¸å˜)
  normalizeOrderData(flatList: RawDbOrder[]): OrderItem[] {
    const orderMap = new Map<string, OrderItem>();

    flatList.forEach((item) => {
      if (!orderMap.has(item.oid)) {
        orderMap.set(item.oid, {
          oid: item.oid,
          status: item.status,
          date: item.createdAt || item.updatedAt,
          amount: 0,
          address: item.address,
          phone: item.phone,
          receiver: item.receiver,
          products: [] as OrderProduct[]
        } as OrderItem);
      }

      const order = orderMap.get(item.oid);

      if (order) {
        const unitPrice = parseFloat(item.price);
        const itemTotalPrice = unitPrice * item.count;
        order.amount += itemTotalPrice;

        order.products.push({
          pid: item.pid,
          name: item.name,
          smallImg: item.smallImg,
          price: unitPrice,
          count: item.count,
          rule: item.rule
        });
      }
    });

    const result = Array.from(orderMap.values());
    result.forEach(order => {
      order.amount = parseFloat(order.amount.toFixed(2));
    });

    return result.sort((a, b) => {
      const timeA = new Date(a.date).getTime();
      const timeB = new Date(b.date).getTime();
      return timeB - timeA;
    });
  }

  // 3. âœ…ã€æš´åŠ›æŸ¥æ‰¾ã€‘æå–è®¢å•æ•°ç»„
  // ä¸ç®¡åŒ…äº†å‡ å±‚ï¼Œåªè¦æ‰¾åˆ° result æ˜¯ä¸ªæ•°ç»„ï¼Œå°±æŠŠå®ƒæŒ–å‡ºæ¥
  findOrderArrayInObject(obj: Object): RawDbOrder[] | null {
    if (!obj) return null;

    // å¼ºåˆ¶è½¬æ¢ä¸º KV ç»“æ„æ–¹ä¾¿è®¿é—®
    const root = obj as Record<string, Object>;

    // ç­–ç•¥ 1: ç›´æ¥çœ‹æœ€å¤–å±‚æœ‰æ²¡æœ‰ result ä¸”æ˜¯æ•°ç»„ (å¯¹åº”æ ‡å‡† API)
    // ç»“æ„: { code: 70000, result: [...] }
    if (root['result'] && Array.isArray(root['result'])) {
      console.info('[MyOrderPage] å‘½ä¸­ç­–ç•¥1: root.result æ˜¯æ•°ç»„');
      return root['result'] as RawDbOrder[];
    }

    // ç­–ç•¥ 2: çœ‹çœ‹ data é‡Œé¢æœ‰æ²¡æœ‰ result (å¯¹åº”å¸¸è§çš„ Wrapper ç»“æ„)
    // ç»“æ„: { code: 200, data: { code: 70000, result: [...] } }
    if (root['data']) {
      let dataObj = root['data'];
      // å¦‚æœ data æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£å¼€
      if (typeof dataObj === 'string') {
        try { dataObj = JSON.parse(dataObj); } catch (e) {}
      }

      const innerData = dataObj as Record<string, Object>;
      if (innerData && innerData['result'] && Array.isArray(innerData['result'])) {
        console.info('[MyOrderPage] å‘½ä¸­ç­–ç•¥2: root.data.result æ˜¯æ•°ç»„');
        return innerData['result'] as RawDbOrder[];
      }

      // ç­–ç•¥ 3: data æœ¬èº«å°±æ˜¯æ•°ç»„?
      if (Array.isArray(dataObj)) {
        console.info('[MyOrderPage] å‘½ä¸­ç­–ç•¥3: root.data æœ¬èº«æ˜¯æ•°ç»„');
        return dataObj as RawDbOrder[];
      }
    }

    // ç­–ç•¥ 4: çœ‹çœ‹ result å­—æ®µé‡Œé¢æœ‰æ²¡æœ‰ result (å¯¹åº”æŸäº›åµŒå¥—ç»“æ„)
    if (root['result']) {
      let resultObj = root['result'];
      if (typeof resultObj === 'string') {
        try { resultObj = JSON.parse(resultObj); } catch (e) {}
      }
      const innerResult = resultObj as Record<string, Object>;
      if (innerResult && innerResult['result'] && Array.isArray(innerResult['result'])) {
        console.info('[MyOrderPage] å‘½ä¸­ç­–ç•¥4: root.result.result æ˜¯æ•°ç»„');
        return innerResult['result'] as RawDbOrder[];
      }
    }

    return null;
  }

  // 4. è·å–è®¢å•
  async fetchOrders(status: number) {
    this.isLoading = true;
    this.orderList = [];

    try {
      // 1. è·å–åŸå§‹å¯¹è±¡ (HttpUtil å·²ç» parse è¿‡äº†)
      const rawRes = await CoffeeApi.findOrder(this.token, status);

      console.info('[MyOrderPage] API å“åº”ç±»å‹: ' + typeof rawRes);

      // ğŸ” è°ƒè¯•å¿…æ€æŠ€ï¼šå¦‚æœå¤±è´¥ï¼Œå¯ä»¥åœ¨ Log é‡Œçœ‹åˆ°çœŸå®æ•°æ®ç»“æ„
      // console.info('[MyOrderPage] çœŸå®æ•°æ®ç»“æ„: ' + JSON.stringify(rawRes));

      // 2. è°ƒç”¨æš´åŠ›æŸ¥æ‰¾å‡½æ•°
      const targetList = this.findOrderArrayInObject(rawRes as Object);

      if (targetList && targetList.length > 0) {
        console.info('[MyOrderPage] æˆåŠŸæå–åˆ°è®¢å•æ¡æ•°: ' + targetList.length);
        this.orderList = this.normalizeOrderData(targetList);
      } else if (targetList && targetList.length === 0) {
        console.info('[MyOrderPage] æå–åˆ°äº†æ•°ç»„ï¼Œä½†æ˜¯æ˜¯ç©ºçš„');
        this.orderList = [];
      } else {
        console.warn('[MyOrderPage] æœªèƒ½åœ¨å“åº”ä¸­æ‰¾åˆ°è®¢å•æ•°ç»„ (result)');
        // å¦‚æœè¿˜ä¸è¡Œï¼Œæ‰“å¼€ä¸Šé¢çš„ JSON.stringify çœ‹çœ‹åˆ°åº•è—åœ¨å“ª
        this.orderList = [];
      }

    } catch (err) {
      console.error('[MyOrderPage] Error:', JSON.stringify(err as Object));
      promptAction.showToast({ message: 'è·å–è®¢å•å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // ... handleReceive å’Œ handleDelete ...
  async handleReceive(oid: string) {
    try {
      const res = await CoffeeApi.receiveOrder(this.token, oid);
      // ç®€å•å®½å®¹åˆ¤æ–­
      const str = JSON.stringify(res);
      if (str.includes('200') || str.includes('success')) {
        promptAction.showToast({ message: 'ç¡®è®¤æ”¶è´§æˆåŠŸ' });
        this.fetchOrders(this.currentStatus);
      } else {
        promptAction.showToast({ message: 'æ“ä½œå¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  async handleDelete(oid: string) {
    try {
      const res = await CoffeeApi.removeOrder(this.token, oid);
      const str = JSON.stringify(res);
      if (str.includes('200') || str.includes('success')) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
        this.fetchOrders(this.currentStatus);
      } else {
        promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  @Builder OrderItemView(item: OrderItem) {
    Column() {
      Row() {
        Text(`è®¢å•å·: ${item.oid}`).fontSize(12).fontColor('#999')
        Blank()
        Text(item.status === 2 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­')
          .fontSize(14)
          .fontColor(item.status === 2 ? '#999' : '#D22028')
      }
      .width('100%').padding({ bottom: 10 })

      Divider().color('#F5F5F5')

      Column() {
        ForEach(item.products, (prod: OrderProduct) => {
          Row() {
            Image(prod.smallImg)
              .width(60).height(60).borderRadius(4)
              .objectFit(ImageFit.Cover)
              .backgroundColor('#F5F5F5')

            Column() {
              Text(prod.name).fontSize(14).fontWeight(FontWeight.Bold).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
              Text(prod.rule).fontSize(12).fontColor('#999').margin({ top: 4 })
            }
            .layoutWeight(1).alignItems(HorizontalAlign.Start).padding({ left: 10 })

            Column() {
              Text(`Â¥${prod.price}`).fontSize(14).fontColor('#333')
              Text(`x${prod.count}`).fontSize(12).fontColor('#999')
            }.alignItems(HorizontalAlign.End)
          }
          .width('100%').padding({ top: 10, bottom: 10 })
        }, (prod: OrderProduct) => `${item.oid}_${prod.pid}`)
      }
      .width('100%')

      Divider().color('#F5F5F5')

      Row() {
        Text(item.date ? item.date.split('T')[0] : '').fontSize(12).fontColor('#999')
        Blank()
        Column() {
          Row() {
            Text('å…±').fontSize(12).fontColor('#999')
            Text(`${item.products.reduce((sum, p) => sum + p.count, 0)}`)
              .fontSize(12).fontColor('#D22028').margin({ left: 2, right: 2 })
            Text('ä»¶å•†å“ åˆè®¡:').fontSize(12).fontColor('#999')
            Text(`Â¥${item.amount}`).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333').margin({ left: 5 })
          }

          Row() {
            if (item.status === 1) {
              Button('ç¡®è®¤æ”¶è´§', { type: ButtonType.Normal })
                .width(80).height(28).fontSize(12).backgroundColor(Color.White).fontColor('#0035AA')
                .border({ width: 1, color: '#0035AA', radius: 14 })
                .margin({ top: 10 })
                .onClick(() => this.handleReceive(item.oid))
            } else if (item.status === 2) {
              Button('åˆ é™¤è®¢å•', { type: ButtonType.Normal })
                .width(80).height(28).fontSize(12).backgroundColor(Color.White).fontColor('#999')
                .border({ width: 1, color: '#CCC', radius: 14 })
                .margin({ top: 10 })
                .onClick(() => {
                  AlertDialog.show({
                    title: 'æç¤º',
                    message: 'ç¡®è®¤åˆ é™¤è¯¥è®¢å•å—ï¼Ÿ',
                    primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
                    secondaryButton: { value: 'åˆ é™¤', fontColor: 'red', action: () => this.handleDelete(item.oid) }
                  })
                })
            }
          }.justifyContent(FlexAlign.End).width('100%')
        }.alignItems(HorizontalAlign.End)
      }
      .width('100%').padding({ top: 10 })
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
  }

  build() {
    Column() {
      Row() {
        Text('<').fontSize(24).fontColor('#333').padding({ right: 20 })
          .onClick(() => router.back())
        Text('æˆ‘çš„è®¢å•').fontSize(18).fontWeight(FontWeight.Bold)
      }
      .width('100%').height(50).padding({ left: 15 }).backgroundColor(Color.White)

      Tabs({ index: this.currentStatus }) {
        TabContent().tabBar('å…¨éƒ¨')
        TabContent().tabBar('è¿›è¡Œä¸­')
        TabContent().tabBar('å·²å®Œæˆ')
      }
      .onChange((index: number) => {
        this.currentStatus = index;
        this.fetchOrders(index);
      })
      .barMode(BarMode.Fixed)
      .barWidth('100%')
      .barHeight(44)

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40).color('#0035AA')
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.orderList.length === 0) {
        Column() {
          Text('æš‚æ— ç›¸å…³è®¢å•').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.orderList, (item: OrderItem) => {
            ListItem() {
              this.OrderItemView(item)
            }
          }, (item: OrderItem) => item.oid)
        }
        .layoutWeight(1)
        .padding(10)
        .width('100%')
      }
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }
}