import router from '@ohos.router';
import CoffeeApi from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction'; // ç”¨äºå¼¹çª—æç¤º

const THEME_COLOR = '#0035AA';
const TEXT_GRAY = '#999999';

@Entry
@Component
struct LoginPage {
  // çŠ¶æ€ç®¡ç†
  @State isForgotPasswordPage: boolean = false;
  @State loginPhone: string = '13800138000'; // æ–¹ä¾¿æµ‹è¯•é¢„å¡«
  @State loginPassword: string = '123456';

  @State fpPhone: string = '';
  @State fpNewPassword: string = '';
  @State fpEmail: string = '';
  @State fpVerifyCode: string = '';

  // æ³¨å†Œå¼¹çª—æ§åˆ¶å™¨
  dialogController: CustomDialogController = new CustomDialogController({
    builder: RegisterDialog(),
    alignment: DialogAlignment.Bottom,
    customStyle: true,
    autoCancel: true
  })

  build() {
    Column() {
      // --- é¡¶éƒ¨å¯¼èˆªæ  ---
      Row() {
        Row({ space: 10 }) {
          // è¿™é‡Œå¯ä»¥æ¢æˆä½ çš„ Logo å›¾ç‰‡
          Text('â˜•').fontSize(30)
          Text('Luckin Coffee')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
        }

        // å³ä¸Šè§’â€œé¦–é¡µâ€æŒ‰é’®
        Text('é¦–é¡µ')
          .fontSize(16)
          .fontColor(THEME_COLOR)
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            router.pushUrl({ url: 'pages/MainPage' });
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ top: 10, bottom: 10 })

      // --- é¡µé¢å†…å®¹åˆ‡æ¢ ---
      if (this.isForgotPasswordPage) {
        this.ForgotPasswordView()
      } else {
        this.LoginView()
      }
    }
    .width('100%')
    .height('100%')
    .padding({ left: 30, right: 30, top: 20 })
    .backgroundColor(Color.White)
  }

  // --- ç™»å½•è§†å›¾ ---
  @Builder
  LoginView() {
    Column() {
      Column({ space: 10 }) {
        Text('æ¬¢è¿å›æ¥ï¼')
          .fontSize(32)
          .fontWeight(FontWeight.Regular)
          .width('100%')
          .fontColor('#333')
        Text('Please login to your accounts')
          .fontSize(18)
          .fontColor(TEXT_GRAY)
          .width('100%')
      }
      .margin({ top: 40, bottom: 40 })

      Column({ space: 0 }) {
        InputRow({ label: 'æ‰‹æœºå·', placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·', value: $loginPhone })
        InputRow({ label: 'å¯†ç ', placeholder: 'è¯·è¾“å…¥å¯†ç ', value: $loginPassword, isPassword: true })

        Text('å¿˜è®°å¯†ç ?')
          .fontSize(14)
          .fontColor('#666')
          .width('100%')
          .textAlign(TextAlign.End)
          .margin({ top: 15, bottom: 30 })
          .onClick(() => {
            animateTo({ duration: 300 }, () => {
              this.isForgotPasswordPage = true;
            })
          })
      }

      Column({ space: 20 }) {
        // --- ç™»å½•æŒ‰é’®é€»è¾‘ä¿®æ”¹ ---
        Button('ç™»å½•', { type: ButtonType.Normal })
          .width('100%')
          .height(50)
          .backgroundColor(THEME_COLOR)
          .borderRadius(25)
          .fontSize(18)
          .onClick(async () => {
            await this.handleLogin();
          })

        Button('æ³¨å†Œ', { type: ButtonType.Normal })
          .width('100%')
          .height(50)
          .backgroundColor(Color.White)
          .border({ width: 1, color: '#E0E0E0' })
          .borderRadius(25)
          .fontColor('#333')
          .fontSize(18)
          .onClick(() => {
            if (this.dialogController != null) {
              this.dialogController.open();
            }
          })
      }
    }
  }

  // å¤„ç†ç™»å½•é€»è¾‘
  // --- æ›¿æ¢ LoginPage.ets ä¸­çš„ handleLogin æ–¹æ³• ---
  async handleLogin() {
    if (!this.loginPhone || !this.loginPassword) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ' });
      return;
    }

    try {
      console.info(`[Login Debug] æ­£åœ¨å°è¯•ç™»å½•... è´¦å·:${this.loginPhone}`);

      // è°ƒç”¨ API (æ­¤æ—¶ res è¢«æ¨æ–­ä¸º ApiResponse<LoginData>)
      const res = await CoffeeApi.login(this.loginPhone, this.loginPassword);

      console.info('[Login Debug] æ¥å£è¿”å›ç»“æœ:', JSON.stringify(res));

      // è·å– Token (å…¼å®¹ä¸¤ç§å¸¸è§æ ¼å¼)
      // ä¼˜å…ˆå–å¤–å±‚ token
      let token: string | undefined = res.token;

      // å¦‚æœå¤–å±‚æ²¡æœ‰ï¼Œä¸” data å­˜åœ¨ï¼Œä¸” data.token å­˜åœ¨
      // ã€å…³é”®ä¿®æ”¹ã€‘ï¼šè¿™é‡Œä¸éœ€è¦ as any äº†ï¼Œå› ä¸º LoginData æ¥å£é‡Œå®šä¹‰äº† token?
      if (!token && res.data && res.data.token) {
        token = res.data.token;
      }

      // éªŒè¯ Token æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©ºå­—ç¬¦ä¸²
      if (String(res.code) === '200' && token) {
        console.info('[Login Debug] ç™»å½•æˆåŠŸï¼ŒToken:', token);
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' });

        // ä¿å­˜ Token å¹¶è·³è½¬
        AppStorage.SetOrCreate('token', token);
        router.pushUrl({ url: 'pages/MainPage' });

      } else {
        const errorMsg = res.msg || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ';
        console.warn('[Login Debug] ç™»å½•å¤±è´¥:', errorMsg);
        promptAction.showToast({ message: errorMsg });
      }

    } catch (err) {
      // è¿™é‡Œçš„ err ç±»å‹æ˜¯ä¸ç¡®å®šçš„ï¼ŒJSON.stringify æ˜¯å®‰å…¨çš„ï¼Œä½†ä¸è¦ç›´æ¥ err.message
      console.error('[Login Debug] ç½‘ç»œæˆ–ä»£ç å¼‚å¸¸');
      promptAction.showToast({ message: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' });
    }
  }

  // --- å¿˜è®°å¯†ç è§†å›¾ ---
  @Builder
  ForgotPasswordView() {
    Column() {
      Column({ space: 10 }) {
        Text('å¿˜è®°å¯†ç !')
          .fontSize(32).fontWeight(FontWeight.Regular).width('100%').fontColor('#333')
      }
      .margin({ top: 40, bottom: 40 })

      Column({ space: 0 }) {
        InputRow({ label: 'æ‰‹æœºå·', placeholder: 'æ‰‹æœºå·', value: $fpPhone })
        InputRow({ label: 'æ–°å¯†ç ', placeholder: 'æ–°å¯†ç ', value: $fpNewPassword, isPassword: true })
        // ... å…¶ä»–è¾“å…¥ç•¥ ...
      }

      Text('å·²æœ‰è´¦å·ï¼Œç«‹å³ç™»å½•')
        .fontSize(14).fontColor('#333').width('100%').textAlign(TextAlign.End).margin({ top: 15, bottom: 40 })
        .onClick(() => {
          animateTo({ duration: 300 }, () => { this.isForgotPasswordPage = false; })
        })

      Button('æ äº¤', { type: ButtonType.Normal })
        .width('100%').height(50).backgroundColor(THEME_COLOR).borderRadius(25).fontSize(18)
    }
  }
}

// --- é€šç”¨ç»„ä»¶ ---
@Component
struct InputRow {
  label: string = '';
  placeholder: string = '';
  @Link value: string;
  isPassword: boolean = false;
  @State showPass: boolean = false;

  build() {
    Column() {
      Row() {
        Text(this.label).width(80).fontSize(16).fontColor('#333')
        TextInput({ text: this.value, placeholder: this.placeholder })
          .layoutWeight(1)
          .backgroundColor(Color.Transparent)
          .type(this.isPassword && !this.showPass ? InputType.Password : InputType.Normal)
          .onChange((val) => { this.value = val; })
          .placeholderColor(TEXT_GRAY)

        // if (this.isPassword) {
        //   Text(this.showPass ? 'ğŸ‘ï¸' : 'ğŸ™ˆ') // ç®€å•å›¾æ ‡ä»£æ›¿
        //     .margin({ right: 10, left: 10 })
        //     .onClick(() => { this.showPass = !this.showPass; })
        // }
      }
      .height(60)
      .width('100%')
      .alignItems(VerticalAlign.Center)
      Divider().color('#F0F0F0').strokeWidth(1)
    }
  }
}

// --- æ³¨å†Œå¼¹çª—ç»„ä»¶ ---
@CustomDialog
struct RegisterDialog {
  controller?: CustomDialogController = undefined;
  @State regPhone: string = '';
  @State regPass: string = '';
  @State regNick: string = '';

  build() {
    Column() {
      Row() {
        Text('æ³¨å†Œ').fontSize(24).fontColor('#333')
        Text('Ã—').fontSize(30).fontColor('#999999').onClick(() => { this.controller?.close() })
      }
      .width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })

      Column() {
        InputRow({ label: 'æ‰‹æœºå·', placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·', value: $regPhone })
        InputRow({ label: 'å¯†ç ', placeholder: 'è¯·è¾“å…¥å¯†ç ', value: $regPass, isPassword: true })
        InputRow({ label: 'æ˜µç§°', placeholder: 'è¯·è¾“å…¥æ˜µç§°', value: $regNick })
      }
      .margin({ bottom: 30 })

      Button('æ³¨å†Œ', { type: ButtonType.Normal })
        .width('100%').height(50).backgroundColor('#0035AA').borderRadius(25).fontSize(18)
        .onClick(async () => {
          await this.handleRegister();
        })
    }
    .width('100%').backgroundColor(Color.White).padding(30).borderRadius({ topLeft: 20, topRight: 20 })
  }

  // æ³¨å†Œé€»è¾‘
  async handleRegister() {
    if (!this.regPhone || !this.regPass || !this.regNick) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯' });
      return;
    }

    try {
      const res = await CoffeeApi.register(this.regPhone, this.regPass, this.regNick);
      console.info('æ³¨å†Œç»“æœ:', JSON.stringify(res));

      if (res.code == 200) {
        promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•' });
        this.controller?.close();
      } else {
        promptAction.showToast({ message: res.msg || 'æ³¨å†Œå¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }
}