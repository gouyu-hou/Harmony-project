import router from '@ohos.router';

@Entry
@Component
struct SecurityPage {
  // ä¿®æ”¹å¯†ç å¼¹çª—
  pwdDialog: CustomDialogController = new CustomDialogController({
    builder: ChangePasswordDialog(),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  })

  // æ³¨é”€ç¡®è®¤å¼¹çª—
  deleteDialog: CustomDialogController = new CustomDialogController({
    builder: ConfirmDialog({
      title: 'æ³¨é”€è´¦å·',
      content: 'æ˜¯å¦ç¡®è®¤æ³¨é”€å·ï¼Œä¸€æ—¦ç¡®è®¤æ— æ³•æ¢å¤ï¼',
      onConfirm: () => {
        // æ‰§è¡Œæ³¨é”€é€»è¾‘ï¼Œè·³è½¬å›žç™»å½•
        router.clear();
        router.pushUrl({ url: 'pages/LoginPage' })
      }
    }),
    alignment: DialogAlignment.Center,
    autoCancel: true
  })

  build() {
    Column() {
      // 1. é¡¶éƒ¨
      Row() {
        Text('< è¿”å›ž').fontSize(16).fontColor('#0035AA').onClick(() => router.back())
        Text('å®‰å…¨ä¸­å¿ƒ').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
      }
      .width('100%').height(50).padding({ left: 15, right: 15 }).backgroundColor(Color.White)

      // è“è‰²èƒŒæ™¯è£…é¥°
      Column().width('100%').height(50).backgroundColor('#0035AA')

      // 2. èœå•åŒºåŸŸ
      Column() {
        this.MenuItem('ä¿®æ”¹å¯†ç ', () => { this.pwdDialog.open() })
        Divider().color('#F0F0F0')
        this.MenuItem('æ³¨é”€è´¦å·', () => { this.deleteDialog.open() })
      }
      .backgroundColor(Color.White).borderRadius(8)
      .margin({ left: 15, right: 15, top: -30 }) // ä¸Šç§»
      .padding({ top: 5, bottom: 5 })

      // ã€ä¿®æ”¹ç‚¹ 1ã€‘å°† Spacer() æ”¹ä¸º Blank()ï¼Œç”¨äºŽè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´
      Blank()

      // 3. é€€å‡ºç™»å½•æŒ‰é’®
      Button('é€€å‡ºç™»å½•', { type: ButtonType.Normal })
        .width('90%').height(50).backgroundColor('#0035AA').borderRadius(25).fontSize(18)
        .margin({ bottom: 30 })
        .onClick(() => {
          // æ¸…é™¤è·¯ç”±æ ˆå¹¶å›žç™»å½•é¡µ
          router.clear();
          router.pushUrl({ url: 'pages/LoginPage' });
        })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  @Builder MenuItem(title: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor('#333')
      Text('>').fontSize(16).fontColor('#999')
    }
    .width('100%').height(55).justifyContent(FlexAlign.SpaceBetween).padding({ left: 15, right: 15 })
    .onClick(onClick)
  }
}

// --- å¼¹çª—ç»„ä»¶ ---

// 1. ä¿®æ”¹å¯†ç å¼¹çª—
@CustomDialog
struct ChangePasswordDialog {
  controller?: CustomDialogController;
  @State oldPwd: string = '';
  @State newPwd: string = '';

  build() {
    Column() {
      // æ ‡é¢˜ + å…³é—­
      Row() {
        Text('ä¿®æ”¹å¯†ç ').fontSize(18).fontWeight(FontWeight.Bold)
        Text('Ã—').fontSize(24).fontColor('#999').onClick(() => this.controller?.close())
      }
      .width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })

      // ã€ä¿®æ”¹ç‚¹ 2ã€‘ä½¿ç”¨æå–å‡ºæ¥çš„ç»„ä»¶ï¼Œå¹¶ä¼ é€’çŠ¶æ€å¼•ç”¨ ($oldPwd)
      // è¿™æ ·è¾“å…¥çš„å†…å®¹æ‰èƒ½ä¿å­˜åˆ°å˜é‡é‡Œ
      PwdInputItem({ label: 'æ—§å¯†ç ', placeholder: 'è¾“å…¥å¯†ç ', text: $oldPwd })
      PwdInputItem({ label: 'æ–°å¯†ç ', placeholder: 'è¾“å…¥å¯†ç ', text: $newPwd })

      // ç¡®è®¤æŒ‰é’®
      Button('ç¡®è®¤ä¿®æ”¹', { type: ButtonType.Normal })
        .width('100%').height(45).backgroundColor('#0035AA').borderRadius(22).margin({ top: 20 })
        .onClick(() => {
          // è¿™é‡Œå¯ä»¥æ‰“å°ä¸€ä¸‹ï¼ŒéªŒè¯è¾“å…¥æ˜¯å¦æˆåŠŸ
          console.info(`ä¿®æ”¹å¯†ç : æ—§=${this.oldPwd}, æ–°=${this.newPwd}`);
          this.controller?.close();
        })
    }
    .width('100%').backgroundColor(Color.White).padding(20)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }
}

// ã€ä¿®æ”¹ç‚¹ 3ã€‘å°†åŽŸæ¥çš„ @Builder PwdInput æå–ä¸ºç‹¬ç«‹çš„ Component
// è¿™æ ·å¯ä»¥ä½¿ç”¨ @Link å®žçŽ°åŒå‘ç»‘å®š
@Component
struct PwdInputItem {
  label: string = '';
  placeholder: string = '';
  @Link text: string; // æŽ¥æ”¶çˆ¶ç»„ä»¶çš„çŠ¶æ€

  build() {
    Row() {
      Text(this.label).width(60).fontSize(16).fontColor('#333')
      TextInput({ text: this.text, placeholder: this.placeholder })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .onChange((value) => {
          this.text = value; // æ›´æ–°çŠ¶æ€
        })
      // ç¡®ä¿ä½ æœ‰è¿™ä¸ªå›¾ç‰‡èµ„æºï¼Œæ²¡æœ‰çš„è¯å¯ä»¥ç”¨ Text('ðŸ‘ï¸') ä»£æ›¿
      Image($r('app.media.denglu_mimakejian'))
        .width(20).height(20).opacity(0.5)
    }
    .height(50).border({ width: { bottom: 1 }, color: '#F0F0F0' })
  }
}


// 2. é€šç”¨ç¡®è®¤å¼¹çª— (ä¿æŒä¸å˜ï¼Œå·²ç»æ²¡æœ‰è¯­æ³•é”™è¯¯)
@CustomDialog
struct ConfirmDialog {
  controller?: CustomDialogController;
  title: string = '';
  content: string = '';
  onConfirm: () => void = () => {};

  build() {
    Column() {
      Text(this.title).fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 10 })
      Text(this.content).fontSize(14).fontColor('#666').margin({ bottom: 20 }).padding({ left: 20, right: 20 })

      Divider().color('#F0F0F0')

      Row() {
        Text('å–æ¶ˆ').layoutWeight(1).textAlign(TextAlign.Center).height(50).fontColor('#666')
          .onClick(() => this.controller?.close())
        Divider().vertical(true).height(50).color('#F0F0F0')
        Text('ç¡®è®¤').layoutWeight(1).textAlign(TextAlign.Center).height(50).fontColor('#0035AA')
          .onClick(() => {
            this.onConfirm();
            this.controller?.close();
          })
      }
    }
    .width('80%').backgroundColor(Color.White).borderRadius(12)
  }
}