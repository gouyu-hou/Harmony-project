import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import CoffeeApi, { ProductDetail, ShopCartItem, ProductItem, ApiResponse } from '../api/CoffeeApi';

// æ‰©å±•æ¥å£ä»¥æ”¯æŒ API è¿”å›çš„é¢å¤–å­—æ®µ (å¦‚ milk)
interface ProductDetailFull extends ProductDetail {
  milk?: string;
  milk_desc?: string;
}

@Entry
@Component
struct ProductDetailPage {
  @State pid: string = '';
  @State product: ProductDetailFull | null = null;
  @State isLoading: boolean = true;

  // åŠ¨æ€è§„æ ¼çŠ¶æ€
  @State currentTemp: string = '';
  @State currentSugar: string = '';
  @State currentCream: string = '';
  @State currentMilk: string = '';
  @State buyCount: number = 1;

  // æ”¶è—çŠ¶æ€
  @State isLiked: boolean = false;
  // è´­ç‰©è½¦æ•°é‡
  @State cartCount: number = 0;

  // ç”¨æˆ·Token
  @StorageLink('token') token: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, string>;
    if (params && params['pid']) {
      this.pid = params.pid;
      this.loadData();
    } else {
      promptAction.showToast({ message: 'å‚æ•°é”™è¯¯' });
      router.back();
    }
  }

  onPageShow() {
    if (this.token) {
      this.updateCartCount();
    }
  }

  async loadData() {
    this.isLoading = true;
    try {
      const detailPromise = CoffeeApi.getProductDetail(this.pid);

      if (this.token) {
        this.checkLikeStatus();
        this.updateCartCount();
      }

      const res = await detailPromise;

      if ((res.code === 200 || res.code === '200') && res.data) {
        if (Array.isArray(res.data) && res.data.length > 0) {
          this.product = res.data[0] as ProductDetailFull;
          this.initSpecs();
        }
      }
    } catch (err) {
      console.error('è¯¦æƒ…åŠ è½½å¤±è´¥', JSON.stringify(err));
      promptAction.showToast({ message: 'å•†å“åŠ è½½å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async updateCartCount() {
    if (!this.token) return;
    try {
      const res: ApiResponse<ShopCartItem[]> = await CoffeeApi.findAllShopcart(this.token);
      if ((res.code === 200 || res.code === '200') && res.data) {
        this.cartCount = res.data.length;
      }
    } catch (err) {
      console.error('è´­ç‰©è½¦æ•°é‡è·å–å¤±è´¥', JSON.stringify(err));
    }
  }

  async checkLikeStatus() {
    if (!this.token) return;
    try {
      const res: ApiResponse<ProductItem[]> = await CoffeeApi.findLike(this.token, this.pid);

      if ((res.code === 200 || res.code === '200') &&
      res.data &&
      Array.isArray(res.data) &&
        res.data.length > 0) {
        this.isLiked = true;
      } else {
        this.isLiked = false;
      }
    } catch (err) {
      this.isLiked = false;
    }
  }

  initSpecs() {
    if (!this.product) return;
    if (this.product.tem) this.currentTemp = this.product.tem.split('/')[0];
    if (this.product.sugar) this.currentSugar = this.product.sugar.split('/')[0];
    if (this.product.cream) this.currentCream = this.product.cream.split('/')[0];
    if (this.product.milk) this.currentMilk = this.product.milk.split('/')[0];
  }

  getRuleString(): string {
    const rules: string[] = [];
    if (this.currentTemp) rules.push(this.currentTemp);
    if (this.currentSugar) rules.push(this.currentSugar);
    if (this.currentCream) rules.push(this.currentCream);
    if (this.currentMilk) rules.push(this.currentMilk);
    return rules.join('/');
  }

  async toggleLike() {
    if (!this.checkLogin()) return;
    const previousState = this.isLiked;
    this.isLiked = !this.isLiked;

    try {
      if (this.isLiked) {
        await CoffeeApi.like(this.token, this.pid);
        promptAction.showToast({ message: 'æ”¶è—æˆåŠŸ' });
      } else {
        await CoffeeApi.notLike(this.token, this.pid);
        promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
      }
    } catch (err) {
      this.isLiked = previousState;
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  async handleAddToCart() {
    if (!this.checkLogin()) return;

    const rule = this.getRuleString();

    try {
      const res = await CoffeeApi.addShopcart(this.token, this.pid, this.buyCount, rule);
      if (res.code === 200 || res.code === '200' || res.code === 'B001' || res.code === 3000 || res.msg === 'Success') {
        promptAction.showToast({ message: 'å·²åŠ å…¥è´­ç‰©è¢‹ ğŸ›ï¸' });
        this.updateCartCount();
      } else {
        promptAction.showToast({ message: res.msg || 'æ·»åŠ å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  checkLogin(): boolean {
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.pushUrl({ url: 'pages/LoginPage' });
      return false;
    }
    return true;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('<').fontSize(24).padding(15).onClick(() => router.back())
        Text('å•†å“è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Bold)
        Blank()
        Text(' ').width(40)
      }
      .width('100%').height(50).backgroundColor(Color.White).zIndex(10)

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(50).height(50).color('#0035AA')
          Text('åŠ è½½ç¾å‘³ä¸­...').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.product) {
        Stack({ alignContent: Alignment.Bottom }) {
          // 2. æ»šåŠ¨å†…å®¹åŒº
          Scroll() {
            Column() {
              // å•†å“å¤§å›¾
              Image(this.product.large_img)
                .width('100%').height(300).objectFit(ImageFit.Cover).backgroundColor('#F5F5F5')

              Column() {
                // æ ‡é¢˜å’Œä»·æ ¼
                Row() {
                  Column() {
                    Text(this.product.name).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333')
                    Text(this.product.enname).fontSize(14).fontColor('#999').margin({ top: 4 })
                  }.alignItems(HorizontalAlign.Start)

                  Blank()
                  Text(`Â¥${Number(this.product.price).toFixed(2)}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#D22028')
                }
                .width('100%').margin({ top: 15, bottom: 15 })

                Divider().color('#EEE')

                // åŠ¨æ€è§„æ ¼
                if (this.product.tem) {
                  SpecView({
                    title: this.product.tem_desc || 'æ¸©åº¦',
                    options: this.product.tem.split('/'),
                    selected: $currentTemp
                  })
                }

                if (this.product.sugar) {
                  SpecView({
                    title: this.product.sugar_desc || 'ç³–åº¦',
                    options: this.product.sugar.split('/'),
                    selected: $currentSugar
                  })
                }

                if (this.product.cream) {
                  SpecView({
                    title: this.product.cream_desc || 'å¥¶æ²¹',
                    options: this.product.cream.split('/'),
                    selected: $currentCream
                  })
                }

                if (this.product.milk) {
                  SpecView({
                    title: this.product.milk_desc || 'å¥¶',
                    options: this.product.milk.split('/'),
                    selected: $currentMilk
                  })
                }

                Divider().color('#EEE').margin({ top: 10, bottom: 10 })

                // æ•°é‡é€‰æ‹©
                Row() {
                  Text('é€‰æ‹©æ•°é‡').fontSize(14).fontColor('#333')
                  Blank()
                  Row() {
                    Text('ï¼').fontSize(15).padding(10).onClick(() => { if (this.buyCount > 1) this.buyCount-- })
                    Text(this.buyCount.toString()).fontSize(16).margin({ left: 10, right: 10 })
                    Text('ï¼‹').fontSize(20).padding(10).onClick(() => this.buyCount++)
                  }
                }.width('100%').height(50)

                // å•†å“æè¿°
                Text('å•†å“æè¿°').fontSize(16).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 10 }).width('100%')
                Text(this.product.desc || 'æš‚æ— æè¿°').fontSize(14).fontColor('#666').lineHeight(24)

                Blank().height(80)
              }
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius({ topLeft: 20, topRight: 20 })
              .margin({ top: -20 })
            }
          }.width('100%').height('100%')

          // 3. åº•éƒ¨æ“ä½œæ  (é‡ç‚¹ä¼˜åŒ–åŒºåŸŸ)
          Row() {
            // å·¦ä¾§ï¼šè´­ç‰©è¢‹ + æ”¶è—
            Row() {
              // --- 1. è´­ç‰©è¢‹æ¨¡å— ---
              Column() {
                // å›¾æ ‡å±‚ (ä½¿ç”¨ Stack å›ºå®šé«˜åº¦ï¼Œç¡®ä¿ä¸æ—è¾¹æ”¶è—å¯¹é½)
                Stack({ alignContent: Alignment.TopEnd }) {
                  Image($r('app.media.shopbag'))
                    .width(24)
                    .height(24)
                    .objectFit(ImageFit.Contain)

                  // çº¢è‰²æ•°é‡è§’æ ‡
                  if (this.cartCount > 0) {
                    Text(this.cartCount > 99 ? '99+' : this.cartCount.toString())
                      .fontSize(8)
                      .fontColor(Color.White)
                      .backgroundColor('#FF0000')
                      .borderRadius(8)
                      .padding({ left: 3, right: 3 })
                      .height(14)
                      .constraintSize({ minWidth: 14 })
                      .textAlign(TextAlign.Center)
                      .offset({ x: 5, y: -5 }) // å¾®è°ƒè§’æ ‡ä½ç½®
                  }
                }
                .width(30)
                .height(30) // å›ºå®šé«˜åº¦ 30
                .alignContent(Alignment.Center)

                // æ–‡å­—å±‚
                Text('è´­ç‰©è¢‹')
                  .fontSize(10)
                  .fontColor('#666')
                  .margin({ top: 0 }) // ç´§è´´å›¾æ ‡
              }
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .width(50)
              .height('100%')
              .onClick(() => {
                // âœ… ä¿®æ”¹ï¼šè·³è½¬åˆ°é¦–é¡µ (MainPage é€šå¸¸åŒ…å«è´­ç‰©è¢‹Tab)
                // è·³è½¬åˆ°ä¸»é¡µï¼Œå¹¶ä¼ é€’ index: 2 ä»¥ä¾¿åˆ‡æ¢åˆ°è´­ç‰©è¢‹ Tab
                router.pushUrl({
                  url: 'pages/MainPage',
                  params: { index: 2 }
                });
              })

              // --- 2. æ”¶è—æ¨¡å— ---
              Column() {
                // å›¾æ ‡å±‚ (åŒæ ·å›ºå®šé«˜åº¦ 30)
                Stack({ alignContent: Alignment.Center }) {
                  Text(this.isLiked ? 'â™¥' : 'â™¡')
                    .fontSize(24)
                    .fontColor(this.isLiked ? '#D22028' : '#333')
                    .fontWeight(this.isLiked ? FontWeight.Bold : FontWeight.Normal)
                    .textAlign(TextAlign.Center)
                }
                .width(30)
                .height(30) // ç¡®ä¿ä¸å·¦è¾¹é«˜åº¦ä¸€è‡´

                // æ–‡å­—å±‚
                Text('æ”¶è—')
                  .fontSize(10)
                  .fontColor('#666')
                  .margin({ top: 0 })
              }
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .width(50)
              .height('100%')
              .onClick(() => this.toggleLike())
              .margin({ left: 10 })
            }
            .padding({ left: 15 })

            // å³ä¾§ï¼šåŠ è´­æŒ‰é’®
            Button('åŠ å…¥è´­ç‰©è¢‹', { type: ButtonType.Normal })
              .layoutWeight(1)
              .height(42) // æŒ‰é’®é«˜åº¦
              .backgroundColor('#0035AA')
              .borderRadius(21)
              .fontSize(16)
              .margin({ left: 15, right: 20 })
              .onClick(() => this.handleAddToCart())
          }
          .width('100%')
          .height(80) // âœ… å¢åŠ é«˜åº¦ï¼Œé˜²æ­¢è¢«åˆ‡
          .padding({ bottom: 15 }) // âœ… åº•éƒ¨å†…è¾¹è·ï¼ŒæŠ¬é«˜å†…å®¹
          .backgroundColor(Color.White)
          .shadow({ radius: 10, color: '#1A000000', offsetY: -2 })
        }
        .width('100%').height('100%')
      }
    }
    .width('100%').height('100%').backgroundColor('#F9F9F9')
  }
}

// è§„æ ¼é€‰æ‹©å­ç»„ä»¶
@Component
struct SpecView {
  @Prop title: string;
  @Prop options: string[];
  @Link selected: string;

  build() {
    Column() {
      Text(this.title).fontSize(14).fontColor('#333').margin({ top: 10, bottom: 8 })
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.options, (opt: string) => {
          Text(opt)
            .fontSize(12)
            .fontColor(this.selected === opt ? Color.White : '#666')
            .backgroundColor(this.selected === opt ? '#0035AA' : '#F0F0F0')
            .padding({ left: 15, right: 15, top: 6, bottom: 6 })
            .borderRadius(15)
            .margin({ right: 10, bottom: 10 })
            .onClick(() => {
              this.selected = opt;
            })
        }, (item: string) => item)
      }
    }.alignItems(HorizontalAlign.Start).width('100%')
  }
}