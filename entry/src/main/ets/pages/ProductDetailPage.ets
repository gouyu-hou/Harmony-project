import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import CoffeeApi, { ProductDetail, ApiResponse } from '../api/CoffeeApi';

@Entry
@Component
struct ProductDetailPage {
  @State pid: string = '';
  @State product: ProductDetail | null = null;
  @State isLoading: boolean = true;

  // è§„æ ¼é€‰æ‹©çŠ¶æ€
  @State currentTemp: string = '';
  @State currentSugar: string = '';
  @State currentCream: string = '';
  @State buyCount: number = 1;

  // æ”¶è—çŠ¶æ€
  @State isLiked: boolean = false;

  // ç”¨æˆ·Token
  @StorageLink('token') token: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, string>;
    if (params && params.pid) {
      this.pid = params.pid;
      this.loadData();
    } else {
      promptAction.showToast({ message: 'å‚æ•°é”™è¯¯' });
      router.back();
    }
  }

  async loadData() {
    this.isLoading = true;
    try {
      const detailPromise = CoffeeApi.getProductDetail(this.pid);

      if (this.token) {
        this.checkLikeStatus();
      }

      const res = await detailPromise;
      // âœ… ä¿®å¤ç‚¹ï¼šæ·»åŠ  [0] å–å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå•†å“è¯¦æƒ…
      if (res.code === 200 && res.data) {
        // å¦‚æœç¼–è¯‘å™¨è®¤ä¸ºå®ƒæ˜¯æ•°ç»„ï¼Œæˆ‘ä»¬å°±å–ç¬¬ä¸€ä¸ªï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼ŒTSå¯èƒ½ä¼šåœ¨è¿™é‡ŒæŠ¥é”™ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨ any æˆ–æ–­è¨€ä¸´æ—¶è¿‡æ¸¡ï¼Œæˆ–è€…ç›´æ¥å–å€¼
        // æ ¹æ®ä½ çš„æŠ¥é”™ï¼Œres.data ç¡®å®æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ res.data[0]
        this.product = Array.isArray(res.data) ? res.data[0] : res.data;
        this.initSpecs();
      }
    } catch (err) {
      console.error('è¯¦æƒ…åŠ è½½å¤±è´¥', err);
      promptAction.showToast({ message: 'å•†å“åŠ è½½å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async checkLikeStatus() {
    if (!this.token) return;
    try {
      const res = await CoffeeApi.findLike(this.token, this.pid);
      // âœ… ä¿®å¤ç‚¹ï¼šæ ¹æ® API è¿”å›åˆ¤æ–­ï¼Œå¦‚æœæœ‰æ•°æ®åˆ™è§†ä¸ºå·²æ”¶è—
      if (res.code === 200 && res.data && Array.isArray(res.data) && res.data.length > 0) {
        this.isLiked = true;
      } else {
        this.isLiked = false;
      }
    } catch (err) {
      this.isLiked = false;
    }
  }

  initSpecs() {
    if (!this.product) return;
    if (this.product.tem) this.currentTemp = this.product.tem.split('/')[0];
    if (this.product.sugar) this.currentSugar = this.product.sugar.split('/')[0];
    if (this.product.cream) this.currentCream = this.product.cream.split('/')[0];
  }

  getRuleString(): string {
    const rules: string[] = [];
    if (this.currentTemp) rules.push(this.currentTemp);
    if (this.currentSugar) rules.push(this.currentSugar);
    if (this.currentCream) rules.push(this.currentCream);
    return rules.join('/');
  }

  async toggleLike() {
    if (!this.checkLogin()) return;

    try {
      if (this.isLiked) {
        const res = await CoffeeApi.notLike(this.token, this.pid);
        if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
          this.isLiked = false;
          promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
        }
      } else {
        const res = await CoffeeApi.like(this.token, this.pid);
        if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
          this.isLiked = true;
          promptAction.showToast({ message: 'æ”¶è—æˆåŠŸ' });
        }
      }
    } catch (err) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥' });
    }
  }

  async handleAddToCart() {
    if (!this.checkLogin()) return;

    const rule = this.getRuleString();
    try {
      const res = await CoffeeApi.addShopcart(this.token, this.pid, this.buyCount, rule);
      if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
        promptAction.showToast({ message: 'å·²åŠ å…¥è´­ç‰©è¢‹ ğŸ›ï¸' });
      } else {
        promptAction.showToast({ message: res.msg || 'æ·»åŠ å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  checkLogin(): boolean {
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.pushUrl({ url: 'pages/LoginPage' });
      return false;
    }
    return true;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('<').fontSize(24).padding(15).onClick(() => router.back())
        Text('å•†å“è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Bold)
        Blank()
        Text(' ').width(40)
      }
      .width('100%').height(50).backgroundColor(Color.White).zIndex(10)

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(50).height(50).color('#0035AA')
          Text('åŠ è½½ç¾å‘³ä¸­...').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.product) {
        Stack({ alignContent: Alignment.Bottom }) {
          // 2. æ»šåŠ¨å†…å®¹åŒº
          Scroll() {
            Column() {
              // å•†å“å¤§å›¾
              Image(this.product.large_img)
                .width('100%').height(300).objectFit(ImageFit.Cover).backgroundColor('#F5F5F5')

              Column() {
                // æ ‡é¢˜å’Œä»·æ ¼
                Row() {
                  Column() {
                    Text(this.product.name).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333')
                    Text(this.product.enname).fontSize(14).fontColor('#999').margin({ top: 4 })
                  }.alignItems(HorizontalAlign.Start)

                  Blank()
                  Text(`Â¥${this.product.price}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#D22028')
                }
                .width('100%').margin({ top: 15, bottom: 15 })

                Divider().color('#EEE')

                // è§„æ ¼é€‰æ‹©åŒº
                if (this.product.tem) {
                  this.SpecSection('æ¸©åº¦', this.product.tem.split('/'), this.currentTemp, (val: string) => this.currentTemp = val)
                }
                if (this.product.sugar) {
                  this.SpecSection('ç³–åº¦', this.product.sugar.split('/'), this.currentSugar, (val: string) => this.currentSugar = val)
                }
                if (this.product.cream) {
                  this.SpecSection('å…¶ä»–', this.product.cream.split('/'), this.currentCream, (val: string) => this.currentCream = val)
                }

                Divider().color('#EEE').margin({ top: 10, bottom: 10 })

                // æ•°é‡é€‰æ‹©
                Row() {
                  Text('é€‰æ‹©æ•°é‡').fontSize(14).fontColor('#333')
                  Blank()
                  Row() {
                    Text('ï¼').fontSize(20).padding(10).onClick(() => { if (this.buyCount > 1) this.buyCount-- })
                    Text(this.buyCount.toString()).fontSize(16).margin({ left: 10, right: 10 })
                    Text('ï¼‹').fontSize(20).padding(10).onClick(() => this.buyCount++)
                  }
                }.width('100%').height(50)

                // å•†å“æè¿°
                Text('å•†å“æè¿°').fontSize(16).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 10 }).width('100%')
                Text(this.product.desc || 'æš‚æ— æè¿°').fontSize(14).fontColor('#666').lineHeight(24)

                Blank().height(80)
              }
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius({ topLeft: 20, topRight: 20 })
              .margin({ top: -20 })
            }
          }.width('100%').height('100%')

          // 3. åº•éƒ¨æ“ä½œæ 
          Row() {
            Column() {
              Text(this.isLiked ? 'â™¥' : 'â™¡')
                .fontSize(24).fontColor(this.isLiked ? '#D22028' : '#333')
              Text('æ”¶è—').fontSize(10).fontColor('#666')
            }
            .padding({ left: 20, right: 20 })
            .onClick(() => this.toggleLike())

            Button('åŠ å…¥è´­ç‰©è¢‹', { type: ButtonType.Normal })
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#0035AA')
              .borderRadius(22)
              .fontSize(16)
              .margin({ left: 10, right: 15 })
              .onClick(() => this.handleAddToCart())
          }
          .width('100%').height(60).backgroundColor(Color.White)
          .shadow({ radius: 10, color: '#1A000000', offsetY: -2 })
        }
        .width('100%').height('100%')
      }
    }
    .width('100%').height('100%').backgroundColor('#F9F9F9')
  }

  @Builder SpecSection(title: string, options: string[], current: string, onSelect: (val: string) => void) {
    Column() {
      Text(title).fontSize(14).fontColor('#333').margin({ top: 10, bottom: 8 })
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(options, (opt: string) => {
          Text(opt)
            .fontSize(12)
            .fontColor(current === opt ? Color.White : '#666')
            .backgroundColor(current === opt ? '#0035AA' : '#F0F0F0')
            .padding({ left: 15, right: 15, top: 6, bottom: 6 })
            .borderRadius(15)
            .margin({ right: 10, bottom: 10 })
            .onClick(() => onSelect(opt))
        }, (item: string) => item)
      }
    }.alignItems(HorizontalAlign.Start).width('100%')
  }
}