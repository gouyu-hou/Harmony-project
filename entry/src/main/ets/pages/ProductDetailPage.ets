import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import CoffeeApi, { ProductDetail, ApiResponse } from '../api/CoffeeApi';

// æ‰©å±•æ¥å£ä»¥æ”¯æŒ API è¿”å›çš„é¢å¤–å­—æ®µ (å¦‚ milk)
interface ProductDetailFull extends ProductDetail {
  milk?: string;
  milk_desc?: string;
}

@Entry
@Component
struct ProductDetailPage {
  @State pid: string = '';
  @State product: ProductDetailFull | null = null;
  @State isLoading: boolean = true;

  // åŠ¨æ€è§„æ ¼çŠ¶æ€
  @State currentTemp: string = '';
  @State currentSugar: string = '';
  @State currentCream: string = '';
  @State currentMilk: string = ''; // æ–°å¢ï¼šå¥¶é€‰é¡¹
  @State buyCount: number = 1;

  // æ”¶è—çŠ¶æ€
  @State isLiked: boolean = false;

  // ç”¨æˆ·Token
  @StorageLink('token') token: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, string>;
    if (params && params.pid) {
      this.pid = params.pid;
      this.loadData();
    } else {
      promptAction.showToast({ message: 'å‚æ•°é”™è¯¯' });
      router.back();
    }
  }

  async loadData() {
    this.isLoading = true;
    try {
      const detailPromise = CoffeeApi.getProductDetail(this.pid);

      if (this.token) {
        this.checkLikeStatus();
      }

      const res = await detailPromise;

      if ((res.code === 200 || res.code === '200') && res.data) {
        if (Array.isArray(res.data) && res.data.length > 0) {
          this.product = res.data[0] as ProductDetailFull;
          this.initSpecs(); // åˆå§‹åŒ–é»˜è®¤é€‰ä¸­é¡¹
        }
      }
    } catch (err) {
      console.error('è¯¦æƒ…åŠ è½½å¤±è´¥', JSON.stringify(err));
      promptAction.showToast({ message: 'å•†å“åŠ è½½å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // âœ… ä¿®å¤ç‚¹ï¼šè§£å†³ Type 'undefined' is not assignable to type 'boolean' æŠ¥é”™
  async checkLikeStatus() {
    if (!this.token) return;
    try {
      const res = await CoffeeApi.findLike(this.token, this.pid);

      // ä½¿ç”¨ä¸¥æ ¼çš„ if åˆ¤æ–­ï¼Œç¡®ä¿åªèµ‹å€¼ true æˆ– false
      if ((res.code === 200 || res.code === '200') &&
      res.data &&
      Array.isArray(res.data) &&
        res.data.length > 0) {
        this.isLiked = true;
      } else {
        this.isLiked = false;
      }
    } catch (err) {
      this.isLiked = false;
    }
  }

  initSpecs() {
    if (!this.product) return;
    // å–æ–œæ å‰çš„ç¬¬ä¸€ä¸ªé€‰é¡¹ä½œä¸ºé»˜è®¤å€¼
    if (this.product.tem) this.currentTemp = this.product.tem.split('/')[0];
    if (this.product.sugar) this.currentSugar = this.product.sugar.split('/')[0];
    if (this.product.cream) this.currentCream = this.product.cream.split('/')[0];
    if (this.product.milk) this.currentMilk = this.product.milk.split('/')[0];
  }

  getRuleString(): string {
    const rules: string[] = [];
    if (this.currentTemp) rules.push(this.currentTemp);
    if (this.currentSugar) rules.push(this.currentSugar);
    if (this.currentCream) rules.push(this.currentCream);
    if (this.currentMilk) rules.push(this.currentMilk);
    return rules.join('/');
  }

  async toggleLike() {
    if (!this.checkLogin()) return;
    const previousState = this.isLiked;
    this.isLiked = !this.isLiked;

    try {
      if (this.isLiked) {
        await CoffeeApi.like(this.token, this.pid);
        promptAction.showToast({ message: 'æ”¶è—æˆåŠŸ' });
      } else {
        await CoffeeApi.notLike(this.token, this.pid);
        promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
      }
    } catch (err) {
      this.isLiked = previousState;
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  async handleAddToCart() {
    if (!this.checkLogin()) return;

    const rule = this.getRuleString();
    console.info(`ã€Debugã€‘åŠ å…¥è´­ç‰©è½¦: PID=${this.pid}, Count=${this.buyCount}, Rule=${rule}`);

    try {
      const res = await CoffeeApi.addShopcart(this.token, this.pid, this.buyCount, rule);
      if (res.code === 200 || res.code === '200' || res.code === 'B001' || res.code === 3000 || res.msg === 'Success') {
        promptAction.showToast({ message: 'å·²åŠ å…¥è´­ç‰©è¢‹ ğŸ›ï¸' });
      } else {
        promptAction.showToast({ message: res.msg || 'æ·»åŠ å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
    }
  }

  checkLogin(): boolean {
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.pushUrl({ url: 'pages/LoginPage' });
      return false;
    }
    return true;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('<').fontSize(24).padding(15).onClick(() => router.back())
        Text('å•†å“è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Bold)
        Blank()
        Text(' ').width(40)
      }
      .width('100%').height(50).backgroundColor(Color.White).zIndex(10)

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(50).height(50).color('#0035AA')
          Text('åŠ è½½ç¾å‘³ä¸­...').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.product) {
        Stack({ alignContent: Alignment.Bottom }) {
          // 2. æ»šåŠ¨å†…å®¹åŒº
          Scroll() {
            Column() {
              // å•†å“å¤§å›¾
              Image(this.product.large_img)
                .width('100%').height(300).objectFit(ImageFit.Cover).backgroundColor('#F5F5F5')

              Column() {
                // æ ‡é¢˜å’Œä»·æ ¼
                Row() {
                  Column() {
                    Text(this.product.name).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333')
                    Text(this.product.enname).fontSize(14).fontColor('#999').margin({ top: 4 })
                  }.alignItems(HorizontalAlign.Start)

                  Blank()
                  // å…¼å®¹ string æˆ– number ç±»å‹çš„ä»·æ ¼
                  Text(`Â¥${Number(this.product.price).toFixed(2)}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#D22028')
                }
                .width('100%').margin({ top: 15, bottom: 15 })

                Divider().color('#EEE')

                // âœ… åŠ¨æ€è§„æ ¼åŒºåŸŸ - ä½¿ç”¨ SpecView ç»„ä»¶è§£å†³ç‚¹å‡»æ— å“åº”é—®é¢˜

                if (this.product.tem) {
                  SpecView({
                    title: this.product.tem_desc || 'æ¸©åº¦', // ä¼˜å…ˆç”¨æ¥å£è¿”å›çš„æ ‡é¢˜
                    options: this.product.tem.split('/'),
                    selected: $currentTemp // åŒå‘ç»‘å®š
                  })
                }

                if (this.product.sugar) {
                  SpecView({
                    title: this.product.sugar_desc || 'ç³–åº¦',
                    options: this.product.sugar.split('/'),
                    selected: $currentSugar
                  })
                }

                if (this.product.cream) {
                  SpecView({
                    title: this.product.cream_desc || 'å¥¶æ²¹',
                    options: this.product.cream.split('/'),
                    selected: $currentCream
                  })
                }

                // å¥¶ (Milk) é€‰é¡¹æ”¯æŒ
                if (this.product.milk) {
                  SpecView({
                    title: this.product.milk_desc || 'å¥¶',
                    options: this.product.milk.split('/'),
                    selected: $currentMilk
                  })
                }

                Divider().color('#EEE').margin({ top: 10, bottom: 10 })

                // æ•°é‡é€‰æ‹©
                Row() {
                  Text('é€‰æ‹©æ•°é‡').fontSize(14).fontColor('#333')
                  Blank()
                  Row() {
                    Text('ï¼').fontSize(15).padding(10).onClick(() => { if (this.buyCount > 1) this.buyCount-- })
                    Text(this.buyCount.toString()).fontSize(16).margin({ left: 10, right: 10 })
                    Text('ï¼‹').fontSize(20).padding(10).onClick(() => this.buyCount++)
                  }
                }.width('100%').height(50)

                // å•†å“æè¿°
                Text('å•†å“æè¿°').fontSize(16).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 10 }).width('100%')
                Text(this.product.desc || 'æš‚æ— æè¿°').fontSize(14).fontColor('#666').lineHeight(24)

                Blank().height(80)
              }
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius({ topLeft: 20, topRight: 20 })
              .margin({ top: -20 })
            }
          }.width('100%').height('100%')

          // 3. åº•éƒ¨æ“ä½œæ 
          Row() {
            Column() {
              Text(this.isLiked ? 'â™¥' : 'â™¡')
                .fontSize(24).fontColor(this.isLiked ? '#D22028' : '#333')
              Text('æ”¶è—').fontSize(10).fontColor('#666')
            }
            .padding({ left: 20, right: 20 })
            .onClick(() => this.toggleLike())

            Button('åŠ å…¥è´­ç‰©è¢‹', { type: ButtonType.Normal })
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#0035AA')
              .borderRadius(22)
              .fontSize(16)
              .margin({ left: 10, right: 15 })
              .onClick(() => this.handleAddToCart())
          }
          .width('100%').height(60).backgroundColor(Color.White)
          .shadow({ radius: 10, color: '#1A000000', offsetY: -2 })
        }
        .width('100%').height('100%')
      }
    }
    .width('100%').height('100%').backgroundColor('#F9F9F9')
  }
}

// âœ… ç‹¬ç«‹ç»„ä»¶ SpecViewï¼šè§£å†³ UI çŠ¶æ€ä¸æ›´æ–°çš„æ ¸å¿ƒ
@Component
struct SpecView {
  @Prop title: string;
  @Prop options: string[];
  @Link selected: string; // å…³é”®ï¼šä½¿ç”¨ @Link å®ç°åŒå‘ç»‘å®š

  build() {
    Column() {
      Text(this.title).fontSize(14).fontColor('#333').margin({ top: 10, bottom: 8 })
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.options, (opt: string) => {
          Text(opt)
            .fontSize(12)
            // åŠ¨æ€æ ·å¼ï¼šæ ¹æ® selected æ”¹å˜é¢œè‰²
            .fontColor(this.selected === opt ? Color.White : '#666')
            .backgroundColor(this.selected === opt ? '#0035AA' : '#F0F0F0')
            .padding({ left: 15, right: 15, top: 6, bottom: 6 })
            .borderRadius(15)
            .margin({ right: 10, bottom: 10 })
            // ç‚¹å‡»æ›´æ–° selectedï¼Œçˆ¶ç»„ä»¶ä¼šè‡ªåŠ¨æ„ŸçŸ¥
            .onClick(() => {
              this.selected = opt;
            })
        }, (item: string) => item)
      }
    }.alignItems(HorizontalAlign.Start).width('100%')
  }
}