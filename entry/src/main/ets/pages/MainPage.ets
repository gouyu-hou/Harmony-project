import router from '@ohos.router';
import { MenuPage } from './MenuPage'; // ‚úÖ ÂºïÂÖ•Áã¨Á´ãÂá∫Êù•ÁöÑËèúÂçïÈ°µ

// --- Êï∞ÊçÆÊ®°ÂûãÂÆö‰πâ (‰æõÈ¶ñÈ°µÂíåÊêúÁ¥¢È°µ‰ΩøÁî®) ---
interface Product {
  id: number;
  name: string;
  enName: string;
  price: number;
  isHot?: boolean;
  category: string;
}

// Ê®°ÊãüÊï∞ÊçÆÂ∫ì (È¶ñÈ°µÂíåÊêúÁ¥¢È°µÁî®)
const PRODUCT_DB: Product[] = [
  { id: 1, name: 'ÁÑ¶Á≥ñÊãøÈìÅ', enName: 'Caramel Latte', price: 28.00, isHot: true, category: 'ÁÉ≠ÂçñÊé®Ëçê' },
  { id: 2, name: 'Ê¶õÊûúÊãøÈìÅ', enName: 'Hazelnut Latte', price: 28.00, isHot: true, category: 'ÁÉ≠ÂçñÊé®Ëçê' },
  { id: 3, name: 'Ê†áÂáÜÁæéÂºè', enName: 'Americano', price: 22.00, isHot: false, category: 'ÂíñÂï°' },
  { id: 4, name: 'ÁîüÊ§∞ÊãøÈìÅ', enName: 'Coconut Latte', price: 29.00, isHot: true, category: 'ÊãøÈìÅ' },
  { id: 5, name: 'Â••ÁëûÁôΩ', enName: 'Flat White', price: 28.00, isHot: true, category: 'ÂíñÂï°' },
  { id: 6, name: 'ÈªëÁ≥ñÊ≥¢Ê≥¢ÊãøÈìÅ', enName: 'Brown Sugar Latte', price: 28.00, isHot: true, category: 'ÊãøÈìÅ' },
  { id: 7, name: 'Êª°ÊùØÁôæÈ¶ôÊûú', enName: 'Passion Fruit', price: 25.00, isHot: true, category: 'Ê∞¥ÊûúËå∂' },
  { id: 8, name: 'Ê§∞Â≠êÂÜ∞', enName: 'Coconut Ice', price: 28.00, isHot: true, category: 'ÁëûÁ∫≥ÂÜ∞' },
];

@Entry
@Component
struct MainApp {
  @State isSearchActive: boolean = false;
  @State currentTabIndex: number = 0;

  build() {
    Stack() {
      // Â∫ïÂ±ÇÔºö‰∏ªÂ∫îÁî® Tabs
      Tabs({ index: this.currentTabIndex }) {
        // Tab 1: È¶ñÈ°µ
        TabContent() {
          HomePage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(0, 'È¶ñÈ°µ', 'üè†'))

        // Tab 2: ËèúÂçï (‰ΩøÁî®ÂØºÂÖ•ÁöÑ MenuPage)
        TabContent() {
          MenuPage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(1, 'ËèúÂçï', '‚òï'))

        // Tab 3: Ë¥≠Áâ©Ë¢ã
        TabContent() {
          BagPage()
        }
        .tabBar(this.TabBuilder(2, 'Ë¥≠Áâ©Ë¢ã', 'üõçÔ∏è'))

        // Tab 4: ÊàëÁöÑ
        TabContent() {
          MineView()
        }
        .tabBar(this.TabBuilder(3, 'ÊàëÁöÑ', 'üë§'))
      }
      .barPosition(BarPosition.End)
      .onChange((index) => {
        this.currentTabIndex = index;
      })

      // È°∂Â±ÇÔºöÂÖ®Â±ÄÊêúÁ¥¢È°µ
      if (this.isSearchActive) {
        SearchPage({
          onBack: () => {
            animateTo({ duration: 300 }, () => { this.isSearchActive = false; })
          }
        })
          .zIndex(999)
          .transition({ type: TransitionType.All, opacity: 0 })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder TabBuilder(index: number, title: string, iconEmoji: string) {
    Column() {
      Text(iconEmoji).fontSize(24).margin({ bottom: 4 })
        .opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(title).fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#0035AA' : '#999999')
    }
    .width('100%').height(50).justifyContent(FlexAlign.Center)
  }
}

// --- ÁªÑ‰ª∂ÔºöÈ¶ñÈ°µ ---
@Component
struct HomePage {
  onSearchClick: () => void = () => {};

  build() {
    Column() {
      // Header
      Row() {
        Column() {
          Text('‰∏ãÂçàÂ•Ω').fontSize(14).fontColor('#333')
          Text('User').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#0035AA')
        }
        .alignItems(HorizontalAlign.Start).margin({ right: 15 })

        // ÂÅáÊêúÁ¥¢Ê°Ü
        Row() {
          Text('üîç').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
          Text('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç').fontSize(14).fontColor('#CCC')
        }
        .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18)
        .onClick(() => { this.onSearchClick(); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      // Content
      Scroll() {
        Column() {
          // Banner
          Swiper() {
            Column() { Text('Banner 1').fontColor(Color.White) }.width('100%').height(200).backgroundColor('#87CEFA').justifyContent(FlexAlign.Center)
            Column() { Text('Banner 2').fontColor(Color.White) }.width('100%').height(200).backgroundColor('#90EE90').justifyContent(FlexAlign.Center)
          }
          .width('100%').height(200).autoPlay(true).indicator(true)

          Text('Áåú‰Ω†ÂñúÊ¨¢').fontSize(18).fontWeight(FontWeight.Bold).width('100%').padding(15)
          ProductGrid({ products: PRODUCT_DB })
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}

// --- ÁªÑ‰ª∂ÔºöË¥≠Áâ©Ë¢ã ---
@Component
struct BagPage {
  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™
      Row() {
        Text('< ËøîÂõû').fontSize(16).fontColor('#0035AA')
        Text('Ë¥≠Áâ©Ë¢ã').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).padding({right: 40})
      }
      .width('100%').height(50).padding({ left: 15, right: 15 })
      .backgroundColor(Color.White)

      // Banner
      Column() {
        Text('luckin coffee ÁöÑÊñ∞È≤ú').fontColor(Color.White).fontSize(14)
        Text('Âñù‰∏ãÁ¨¨‰∏ÄÂè£Ôºå‰Ω†Â∞±ÊáÇ‰∫Ü').fontColor(Color.White).fontSize(12).margin({top:5})
      }
      .width('100%').height(80).backgroundColor('#A89A8E').justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Start).padding({left: 20})

      // Á©∫Áä∂ÊÄÅ
      Column() {
        Text('‚úñ').fontSize(60).fontColor('#DDD').margin({ bottom: 20 })
        Text('ËØ∑ÂÖàÁôªÂΩï').fontSize(14).fontColor('#999').margin({ bottom: 30 })

        Button('ÂéªÁôªÂΩï', { type: ButtonType.Normal })
          .width(120).height(40)
          .backgroundColor('#0035AA')
          .borderRadius(20)
          .fontSize(14)
          .onClick(() => {
            router.pushUrl({ url: 'pages/LoginPage' });
          })
      }
      .layoutWeight(1).width('100%').justifyContent(FlexAlign.Center)
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }
}

// --- ÁªÑ‰ª∂ÔºöÊàëÁöÑÈ°µÈù¢ ---
@Component
struct MineView {
  build() {
    Column() {
      // È°∂ÈÉ®ËÉåÊôØÂå∫Âüü
      Stack({ alignContent: Alignment.BottomStart }) {
        // ËÉåÊôØËâ≤Âùó‰ª£ÊõøÂõæÁâá
        Column().width('100%').height(200).backgroundColor('#333')

        // Áî®Êà∑‰ø°ÊÅØ
        Row() {
          // Â§¥ÂÉèÂç†‰Ωç
          Stack({ alignContent: Alignment.Center }) {
            Circle().width(60).height(60).fill(Color.White)
            Text('Â§¥ÂÉè').fontSize(12)
          }.margin({ right: 15 })

          Column() {
            Text('ËãüÂÆá').fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ bottom: 5 })
            Text('2022‰∏é‰Ω†Áõ∏Á∫¶Âú®Á≤§ÂµåÔºåÁà±‰Ω†Âë¶‰πà‰πàÂìí').fontSize(12).fontColor('#EEE')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%').padding({ left: 20, bottom: 30 })
      }
      .width('100%').height(200)

      // ÂäüËÉΩËèúÂçï
      Column() {
        this.MenuItem('‰∏™‰∫∫ËµÑÊñô', () => { router.pushUrl({ url: 'pages/UserInfoPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('ÊàëÁöÑËÆ¢Âçï', () => { router.pushUrl({ url: 'pages/MyOrderPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('ÊàëÁöÑÊî∂Ëóè', () => { router.pushUrl({ url: 'pages/MyFavoritePage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('Âú∞ÂùÄÁÆ°ÁêÜ', () => { router.pushUrl({ url: 'pages/AddressListPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('ÂÆâÂÖ®‰∏≠ÂøÉ', () => { router.pushUrl({ url: 'pages/SecurityPage' }) })
      }
      .width('100%').backgroundColor(Color.White).borderRadius({ topLeft: 12, topRight: 12 })
      .margin({ top: -15 }).padding({ top: 10, bottom: 10 })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  @Builder MenuItem(title: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor('#333')
      Text('>').fontSize(16).fontColor('#999')
    }
    .width('100%').height(55).justifyContent(FlexAlign.SpaceBetween).padding({ left: 20, right: 20 })
    .backgroundColor(Color.White).onClick(onClick)
  }
}

// --- ÁªÑ‰ª∂ÔºöÊêúÁ¥¢È°µ ---
@Component
struct SearchPage {
  onBack: () => void = () => {};
  @State searchText: string = '';
  @State searchHistory: string[] = ['ÊãøÈìÅ', 'ÁæéÂºè'];
  @State searchResults: Product[] = [];

  build() {
    Column() {
      Row() {
        Text('<').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333').padding({ right: 10 }).onClick(() => this.onBack())
        TextInput({ placeholder: 'ËØ∑ËæìÂÖ•ÂíñÂï°ÂêçÁß∞', text: this.searchText })
          .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18).margin({ left: 10, right: 10 }).padding({ left: 15 })
          .enterKeyType(EnterKeyType.Search)
          .onChange((value) => { this.searchText = value; })
          .onSubmit(() => { this.performSearch(this.searchText); })

        Text('ÊêúÁ¥¢').fontSize(16).fontColor('#0035AA').onClick(() => { this.performSearch(this.searchText); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      if (this.searchResults.length === 0) {
        Column() {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.searchHistory, (item: string, index: number) => {
              Row() {
                Text(item).fontSize(14).fontColor('#666')
                Text('√ó').fontSize(14).fontColor('#999').margin({ left: 5 }).onClick(() => { this.searchHistory.splice(index, 1); })
              }
              .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor('#F5F5F5').borderRadius(4).margin({ right: 10, bottom: 10 })
              .onClick(() => { this.searchText = item; this.performSearch(item); })
            })
          }
          .padding({ top: 10, bottom: 20 })
          if (this.searchHistory.length > 0) {
            Button('Ê∏ÖÈô§ÊâÄÊúâÊêúÁ¥¢ÂéÜÂè≤', { type: ButtonType.Normal }).backgroundColor('#F0F0F0').fontColor('#999').fontSize(12).width(150).height(30).borderRadius(15).onClick(() => { this.searchHistory = []; })
          }
        }
        .width('100%').padding(15).alignItems(HorizontalAlign.Center)
      } else {
        Scroll() { ProductGrid({ products: this.searchResults }) }.layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  performSearch(keyword: string) {
    if (!keyword || keyword.trim() === '') { this.searchResults = []; return; }
    this.searchResults = PRODUCT_DB.filter(product => product.name.includes(keyword) || product.enName.toLowerCase().includes(keyword.toLowerCase()));
    if (!this.searchHistory.includes(keyword)) { this.searchHistory.unshift(keyword); }
  }
}

// --- ÁªÑ‰ª∂ÔºöÂïÜÂìÅÁΩëÊ†º ---
@Component
struct ProductGrid {
  @Prop products: Product[];
  build() {
    Grid() {
      ForEach(this.products, (item: Product) => {
        GridItem() {
          Column() {
            Stack({ alignContent: Alignment.TopStart }) {
              Column() { Text('‚òï').fontSize(40) }.width('100%').height(150).backgroundColor('#EEEEEE').justifyContent(FlexAlign.Center).borderRadius({ topLeft: 8, topRight: 8 })
              if (item.isHot) {
                Text('ÁÉ≠Âçñ').fontSize(10).fontColor(Color.White).backgroundColor('#FF4400').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius({ topLeft: 8, bottomRight: 8 })
              }
            }
            Column() {
              Text(item.name).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%')
              Text(item.enName).fontSize(12).fontColor('#999').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%').margin({ top: 2, bottom: 10 })
              Row() {
                Text(`¬•${item.price.toFixed(2)}`).fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)
                Text('‚äï').fontSize(24).fontColor('#0035AA')
              }
              .width('100%').justifyContent(FlexAlign.SpaceBetween)
            }
            .padding(10).backgroundColor(Color.White)
          }
          .borderRadius(8).backgroundColor(Color.White).shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })
        }
      })
    }
    .columnsTemplate('1fr 1fr').columnsGap(10).rowsGap(10).padding(10).width('100%').height('100%')
  }
}