import router from '@ohos.router';
import { MenuPage } from './MenuPage';
import CoffeeApi, { BannerItem, ProductItem, UserInfo, ShopCartItem, ApiResponse } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

// --- æœ¬åœ°æ•°æ®æ¨¡å‹ ---
interface Product {
  id: number;
  name: string;
  enName: string;
  price: number;
  isHot?: boolean;
  category: string;
  smallImg?: string;
}

// æ¨¡æ‹Ÿæ•°æ®åº“
const PRODUCT_DB: Product[] = [
  { id: 1, name: 'ç„¦ç³–æ‹¿é“', enName: 'Caramel Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: 2, name: 'æ¦›æœæ‹¿é“', enName: 'Hazelnut Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: 3, name: 'æ ‡å‡†ç¾å¼', enName: 'Americano', price: 22.00, isHot: false, category: 'å’–å•¡' },
  { id: 4, name: 'ç”Ÿæ¤°æ‹¿é“', enName: 'Coconut Latte', price: 29.00, isHot: true, category: 'æ‹¿é“' },
  { id: 5, name: 'å¥¥ç‘ç™½', enName: 'Flat White', price: 28.00, isHot: true, category: 'å’–å•¡' },
  { id: 6, name: 'é»‘ç³–æ³¢æ³¢æ‹¿é“', enName: 'Brown Sugar Latte', price: 28.00, isHot: true, category: 'æ‹¿é“' },
  { id: 7, name: 'æ»¡æ¯ç™¾é¦™æœ', enName: 'Passion Fruit', price: 25.00, isHot: true, category: 'æ°´æœèŒ¶' },
  { id: 8, name: 'æ¤°å­å†°', enName: 'Coconut Ice', price: 28.00, isHot: true, category: 'ç‘çº³å†°' },
];

@Entry
@Component
struct MainApp {
  @State isSearchActive: boolean = false;
  @State currentTabIndex: number = 0;

  build() {
    Stack() {
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          HomePage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'ğŸ '))

        TabContent() {
          MenuPage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(1, 'èœå•', 'â˜•'))

        TabContent() {
          BagPage()
        }
        .tabBar(this.TabBuilder(2, 'è´­ç‰©è¢‹', 'ğŸ›ï¸'))

        TabContent() {
          MineView()
        }
        .tabBar(this.TabBuilder(3, 'æˆ‘çš„', 'ğŸ‘¤'))
      }
      .barPosition(BarPosition.End)
      .onChange((index) => {
        this.currentTabIndex = index;
      })

      if (this.isSearchActive) {
        SearchPage({
          onBack: () => {
            animateTo({ duration: 300 }, () => { this.isSearchActive = false; })
          }
        })
          .zIndex(999)
          .transition({ type: TransitionType.All, opacity: 0 })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder TabBuilder(index: number, title: string, iconEmoji: string) {
    Column() {
      Text(iconEmoji).fontSize(24).margin({ bottom: 4 })
        .opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(title).fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#0035AA' : '#999999')
    }
    .width('100%').height(50).justifyContent(FlexAlign.Center)
  }
}

// --- ç»„ä»¶ï¼šé¦–é¡µ ---
@Component
struct HomePage {
  onSearchClick: () => void = () => {};

  @StorageLink('userInfo') userInfoStr: string = '{}';

  get user(): UserInfo {
    const defaultUser: UserInfo = { userId: '', nickName: 'Guest', userImg: '' };
    if (!this.userInfoStr || this.userInfoStr === '{}') {
      return defaultUser;
    }
    try {
      const parsed = JSON.parse(this.userInfoStr) as UserInfo;
      return parsed ? parsed : defaultUser;
    } catch {
      return defaultUser;
    }
  }

  @State banners: BannerItem[] = [];

  aboutToAppear() {
    this.fetchBanners();
  }

  async fetchBanners() {
    try {
      const res = await CoffeeApi.getBanner();
      if (res.code === 200 && res.data) {
        this.banners = res.data;
      }
    } catch (err) {
      console.error('[HomePage Error] Banner è·å–å¤±è´¥');
    }
  }

  build() {
    Column() {
      Row() {
        Column() {
          Text('ä¸‹åˆå¥½').fontSize(14).fontColor('#333')
          Text(this.user?.nickName ?? 'Guest')
            .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#0035AA')
        }
        .alignItems(HorizontalAlign.Start).margin({ right: 15 })

        Row() {
          Text('ğŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
          Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
        }
        .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18)
        .onClick(() => { this.onSearchClick(); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      Scroll() {
        Column() {
          if (this.banners.length > 0) {
            Swiper() {
              ForEach(this.banners, (item: BannerItem) => {
                Image(item.bannerImg)
                  .width('100%').height(200).backgroundColor('#F0F0F0')
                  .borderRadius(8).objectFit(ImageFit.Cover)
              }, (item: BannerItem, index: number) => item.pid ? `${item.pid}` : `${index}`)
            }
            .width('100%').height(200).autoPlay(true).indicator(true)
          } else {
            Row().width('100%').height(200).backgroundColor('#F0F0F0').borderRadius(8)
          }

          Text('çŒœä½ å–œæ¬¢').fontSize(18).fontWeight(FontWeight.Bold).width('100%').padding(15)
          ProductGrid({ products: PRODUCT_DB })
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}

// --- ç»„ä»¶ï¼šè´­ç‰©è¢‹ (å®Œå…¨ä¿®å¤ç‰ˆ) ---
@Component
struct BagPage {
  @StorageLink('token') token: string = '';
  @State cartList: ShopCartItem[] = [];
  @State totalPrice: number = 0;

  onPageShow() {
    this.fetchCartList();
  }

  aboutToAppear() {
    this.fetchCartList();
  }

  async fetchCartList() {
    if (!this.token) {
      this.cartList = [];
      this.totalPrice = 0;
      return;
    }
    try {
      const res: ApiResponse<ShopCartItem[]> = await CoffeeApi.getShopcartList(this.token);
      if (res.code === 200 && res.data) {
        // âœ… å®‰å…¨æ ¡éªŒï¼šç¡®ä¿ data æ˜¯æ•°ç»„
        this.cartList = Array.isArray(res.data) ? res.data : [];
        this.calculateTotal();
      } else {
        this.cartList = [];
        this.totalPrice = 0;
      }
    } catch (err) {
      console.error('è·å–è´­ç‰©è½¦å¤±è´¥');
      this.cartList = [];
    }
  }

  calculateTotal() {
    let total = 0;
    this.cartList.forEach((item) => {
      total += item.price * item.count;
    });
    this.totalPrice = total;
  }

  async handleCountChange(sid: string, newCount: number) {
    if (newCount < 1) return;
    try {
      const res: ApiResponse<null> = await CoffeeApi.updateShopcartCount(this.token, sid, newCount);
      if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
        const item = this.cartList.find(i => i.sid === sid);
        if (item) {
          item.count = newCount;
          this.calculateTotal();
        }
      }
    } catch (err) {
      console.error('ä¿®æ”¹æ•°é‡å¤±è´¥');
    }
  }

  async handleDelete(sid: string) {
    try {
      const res: ApiResponse<null> = await CoffeeApi.deleteShopcart(this.token, [sid]);
      if (res.code === 200 || res.code === 'B001' || res.msg === 'Success') {
        this.cartList = this.cartList.filter(item => item.sid !== sid);
        this.calculateTotal();
        promptAction.showToast({ message: 'å·²åˆ é™¤' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  // âœ… æ ¸å¿ƒä¿®å¤ï¼šå°† ListItem æå–ä¸º @Builder
  // è¿™èƒ½è§£å†³ ForEach å†…éƒ¨ "is not callable" çš„ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜
  @Builder renderCartItem(item: ShopCartItem) {
    ListItem() {
      Row() {
        Image(item.small_img).width(80).height(80).borderRadius(8).objectFit(ImageFit.Cover).backgroundColor('#F5F5F5')

        Column() {
          Text(item.name).fontSize(16).fontWeight(FontWeight.Bold).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(item.rule).fontSize(12).fontColor('#999').margin({ top: 5 })
          Blank()
          Row() {
            Text(`Â¥${item.price}`).fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)
            Blank()
            Row() {
              Text('ï¼').fontSize(20).fontColor('#0035AA').padding({ left: 10, right: 10 })
                .onClick(() => this.handleCountChange(item.sid, item.count - 1))
              Text(`${item.count}`).fontSize(14)
              Text('ï¼‹').fontSize(20).fontColor('#0035AA').padding({ left: 10, right: 10 })
                .onClick(() => this.handleCountChange(item.sid, item.count + 1))
            }
          }.width('100%')
        }
        .layoutWeight(1).height(80).margin({ left: 10 }).alignItems(HorizontalAlign.Start)

        Text('Ã—').fontSize(24).fontColor('#999').padding(10)
          .onClick(() => {
            AlertDialog.show({
              title: 'æç¤º',
              message: 'ç¡®å®šåˆ é™¤è¯¥å•†å“å—ï¼Ÿ',
              primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
              secondaryButton: { value: 'åˆ é™¤', fontColor: 'red', action: () => this.handleDelete(item.sid) }
            })
          })
      }
      .width('100%').padding(10).backgroundColor(Color.White).borderRadius(8)
    }
  }

  build() {
    Column() {
      Row() {
        Text('è´­ç‰©è¢‹').fontSize(18).fontWeight(FontWeight.Bold)
      }
      .width('100%').height(50).justifyContent(FlexAlign.Center).backgroundColor(Color.White)

      if (!this.token) {
        Column() {
          Image($r('app.media.shopbag_bg')).width(200).height(200).objectFit(ImageFit.Contain)
          Text('æ‚¨è¿˜æ²¡æœ‰ç™»å½•å“¦').fontSize(14).fontColor('#999').margin({ top: 10 })
          Button('å»ç™»å½•', { type: ButtonType.Normal })
            .width(120).height(40).backgroundColor('#0035AA').borderRadius(20).margin({ top: 20 })
            .onClick(() => { router.pushUrl({ url: 'pages/LoginPage' }) })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.cartList.length === 0) {
        Column() {
          Image($r('app.media.shopbag_bg')).width(200).height(200).objectFit(ImageFit.Contain)
          Text('è´­ç‰©è¢‹ç©ºç©ºå¦‚ä¹Ÿ').fontSize(14).fontColor('#999').margin({ top: 10 })
          Button('å»é€›é€›', { type: ButtonType.Normal })
            .width(120).height(40).backgroundColor('#0035AA').borderRadius(20).margin({ top: 20 })
            .onClick(() => {
              promptAction.showToast({ message: 'è¯·ç‚¹å‡»åº•éƒ¨èœå•è¿›è¡Œé€‰è´­' });
            })
        }.layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10 }) {
          // âœ… ä¿®å¤ï¼šåœ¨ ForEach ä¸­ç›´æ¥è°ƒç”¨ @Builder
          ForEach(this.cartList, (item: ShopCartItem) => {
            this.renderCartItem(item)
          }, (item: ShopCartItem, index: number) => {
            // ç¡®ä¿ Key æ˜¯å­—ç¬¦ä¸²
            return item.sid ? `${item.sid}` : `cart_item_${index}`;
          })
        }.layoutWeight(1).padding(10).width('100%')

        Row() {
          Text(`åº”ä»˜åˆè®¡: Â¥${this.totalPrice}`).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
          Button('å»ç»“ç®—', { type: ButtonType.Normal })
            .width(100).height(40).backgroundColor('#0035AA').borderRadius(20)
            .onClick(() => {
              promptAction.showToast({ message: 'ç»“ç®—åŠŸèƒ½å¾…å¼€å‘' });
            })
        }
        .width('100%').height(60).backgroundColor(Color.White).padding({ left: 15, right: 15 })
        .justifyContent(FlexAlign.SpaceBetween)
        .shadow({ radius: 10, color: '#1A000000', offsetY: -2 })
      }
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }
}

// --- ç»„ä»¶ï¼šæˆ‘çš„é¡µé¢ ---
@Component
struct MineView {
  @StorageLink('token') token: string = '';
  @StorageLink('userInfo') userInfoStr: string = '{}';

  get user(): UserInfo {
    const defaultUser: UserInfo = { userId: '', nickName: '', userImg: '' };
    if (!this.userInfoStr || this.userInfoStr === '{}') {
      return defaultUser;
    }
    try {
      const parsed = JSON.parse(this.userInfoStr) as UserInfo;
      return parsed ? parsed : defaultUser;
    } catch {
      return defaultUser;
    }
  }

  build() {
    Column() {
      Stack({ alignContent: Alignment.BottomStart }) {
        Column().width('100%').height(200).backgroundColor('#333')

        Row() {
          Stack({ alignContent: Alignment.Center }) {
            Image(this.token && this.user?.userImg ? this.user.userImg : $r('app.media.home'))
              .width(60).height(60).borderRadius(30).backgroundColor(Color.White)
              .objectFit(ImageFit.Cover)
              .alt($r('app.media.home'))
          }.margin({ right: 15 })

          Column() {
            Text(this.token ? (this.user?.nickName ?? 'ç”¨æˆ·') : 'ç‚¹å‡»ç™»å½•')
              .fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ bottom: 5 })
              .onClick(() => {
                if (!this.token) router.pushUrl({ url: 'pages/LoginPage' });
              })

            Text(this.token ? (this.user?.desc ?? 'æ¬¢è¿å›æ¥') : 'ç™»å½•äº«å—æ›´å¤šæƒç›Š')
              .fontSize(12).fontColor('#EEE')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%').padding({ left: 20, bottom: 30 })
      }
      .width('100%').height(200)

      Column() {
        this.MenuItem('ä¸ªäººèµ„æ–™', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/UserInfoPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„è®¢å•', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/MyOrderPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„æ”¶è—', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/MyFavoritePage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('åœ°å€ç®¡ç†', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/AddressListPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('å®‰å…¨ä¸­å¿ƒ', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/SecurityPage' }) })

        if (this.token) {
          Divider().color('#F5F5F5')
          Row() {
            Text('é€€å‡ºç™»å½•').fontSize(16).fontColor('#D22028')
          }
          .width('100%').height(55).justifyContent(FlexAlign.Center)
          .backgroundColor(Color.White)
          .onClick(() => {
            this.handleLogout();
          })
        }
      }
      .width('100%').backgroundColor(Color.White).borderRadius({ topLeft: 12, topRight: 12 })
      .margin({ top: -15 }).padding({ top: 10, bottom: 10 })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  @Builder MenuItem(title: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor('#333')
      Text('>').fontSize(16).fontColor('#999')
    }
    .width('100%').height(55).justifyContent(FlexAlign.SpaceBetween).padding({ left: 20, right: 20 })
    .backgroundColor(Color.White).onClick(onClick)
  }

  checkLogin(): boolean {
    if (!this.token) {
      router.pushUrl({ url: 'pages/LoginPage' });
      return false;
    }
    return true;
  }

  handleLogout() {
    AlertDialog.show({
      title: 'æç¤º',
      message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
      secondaryButton: {
        value: 'é€€å‡º', fontColor: '#D22028',
        action: () => {
          AppStorage.SetOrCreate('token', '');
          AppStorage.SetOrCreate('userInfo', '{}');
          router.replaceUrl({ url: 'pages/LoginPage' });
        }
      }
    })
  }
}

// --- ç»„ä»¶ï¼šæœç´¢é¡µ ---
@Component
struct SearchPage {
  onBack: () => void = () => {};
  @State searchText: string = '';
  @State searchHistory: string[] = ['æ‹¿é“', 'ç¾å¼'];
  @State searchResults: Product[] = [];

  build() {
    Column() {
      Row() {
        Text('<').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333').padding({ right: 10 }).onClick(() => this.onBack())
        TextInput({ placeholder: 'è¯·è¾“å…¥å’–å•¡åç§°', text: this.searchText })
          .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18).margin({ left: 10, right: 10 }).padding({ left: 15 })
          .enterKeyType(EnterKeyType.Search)
          .onChange((value) => { this.searchText = value; })
          .onSubmit(() => { this.performSearch(this.searchText); })

        Text('æœç´¢').fontSize(16).fontColor('#0035AA').onClick(() => { this.performSearch(this.searchText); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      if (this.searchResults.length === 0) {
        Column() {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.searchHistory, (item: string, index: number) => {
              Row() {
                Text(item).fontSize(14).fontColor('#666')
                Text('Ã—').fontSize(14).fontColor('#999').margin({ left: 5 }).onClick(() => { this.searchHistory.splice(index, 1); })
              }
              .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor('#F5F5F5').borderRadius(4).margin({ right: 10, bottom: 10 })
              .onClick(() => { this.searchText = item; this.performSearch(item); })
            }, (item: string, index: number) => `${item}_${index}`)
          }
          .padding({ top: 10, bottom: 20 })
          if (this.searchHistory.length > 0) {
            Button('æ¸…é™¤æ‰€æœ‰æœç´¢å†å²', { type: ButtonType.Normal }).backgroundColor('#F0F0F0').fontColor('#999').fontSize(12).width(150).height(30).borderRadius(15).onClick(() => { this.searchHistory = []; })
          }
        }
        .width('100%').padding(15).alignItems(HorizontalAlign.Center)
      } else {
        Scroll() { ProductGrid({ products: this.searchResults }) }.layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  async performSearch(keyword: string) {
    if (!keyword || keyword.trim() === '') {
      this.searchResults = [];
      return;
    }

    // è®°å½•å†å²
    if (!this.searchHistory.includes(keyword)) {
      this.searchHistory.unshift(keyword);
    }

    // âœ… è°ƒç”¨ API æœç´¢
    try {
      const res = await CoffeeApi.search(keyword);
      if (res.code === 200 && res.data) {
        // âœ… ä¿®å¤ç‚¹ï¼šç§»é™¤ as unknownï¼Œæ˜¾å¼æŒ‡å®š map çš„è¿”å›ç±»å‹ä¸º Product
        this.searchResults = res.data.map((item: ProductItem): Product => {
          return {
            id: parseInt(item.pid),        // å°† string è½¬ number
            name: item.name,
            enName: item.enname,
            price: parseFloat(item.price), // å°† string è½¬ number
            smallImg: item.smallImg,
            category: 'Search',
            isHot: false
          };
        });
      } else {
        this.searchResults = [];
      }
    } catch (err) {
      console.error('æœç´¢å¤±è´¥');
      this.searchResults = [];
    }
  }
}

// --- ç»„ä»¶ï¼šå•†å“ç½‘æ ¼ ---
@Component
struct ProductGrid {
  @Prop products: Product[] = [];

  build() {
    Grid() {
      ForEach(this.products, (item: Product) => {
        GridItem() {
          Column() {
            Stack({ alignContent: Alignment.TopStart }) {
              Column() { Text('â˜•').fontSize(40) }.width('100%').height(150).backgroundColor('#EEEEEE').justifyContent(FlexAlign.Center).borderRadius({ topLeft: 8, topRight: 8 })
              if (item.isHot) {
                Text('çƒ­å–').fontSize(10).fontColor(Color.White).backgroundColor('#FF4400').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius({ topLeft: 8, bottomRight: 8 })
              }
            }
            Column() {
              Text(item.name).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%')
              Text(item.enName).fontSize(12).fontColor('#999').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%').margin({ top: 2, bottom: 10 })
              Row() {
                Text(`Â¥${item.price.toFixed(2)}`).fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)
                Text('âŠ•').fontSize(24).fontColor('#0035AA')
                  .onClick(() => {
                    router.pushUrl({
                      url: 'pages/ProductDetailPage',
                      params: { pid: item.id.toString() }
                    })
                  })
              }
              .width('100%').justifyContent(FlexAlign.SpaceBetween)
            }
            .padding(10).backgroundColor(Color.White)
          }
          .borderRadius(8).backgroundColor(Color.White).shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })
        }
      }, (item: Product) => `${item.id}`)
    }
    .columnsTemplate('1fr 1fr').columnsGap(10).rowsGap(10).padding(10).width('100%').height('100%')
  }
}