import router from '@ohos.router';
import { MenuPage } from './MenuPage';
import CoffeeApi, { BannerItem } from '../api/CoffeeApi';

// --- æ•°æ®æ¨¡å‹å®šä¹‰ ---
// âš ï¸ æ³¨æ„ï¼šä¸ºäº†é¿å…ç±»å‹å†²çªï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨ API ä¸­çš„ ProductItem
// è¿™é‡Œä¸ºäº†å…¼å®¹ä½ ç°åœ¨çš„ä»£ç ï¼Œä¿ç•™äº†æœ¬åœ° Product å®šä¹‰
interface Product {
  id: number;
  name: string;
  enName: string;
  price: number;
  isHot?: boolean;
  category: string;
  // å…¼å®¹å­—æ®µï¼šåç»­å¯¹æ¥ API æ—¶å›¾ç‰‡å­—æ®µé€šå¸¸æ˜¯ smallImg
  smallImg?: string;
}

// æ¨¡æ‹Ÿæ•°æ®åº“
const PRODUCT_DB: Product[] = [
  { id: 1, name: 'ç„¦ç³–æ‹¿é“', enName: 'Caramel Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: 2, name: 'æ¦›æœæ‹¿é“', enName: 'Hazelnut Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: 3, name: 'æ ‡å‡†ç¾å¼', enName: 'Americano', price: 22.00, isHot: false, category: 'å’–å•¡' },
  { id: 4, name: 'ç”Ÿæ¤°æ‹¿é“', enName: 'Coconut Latte', price: 29.00, isHot: true, category: 'æ‹¿é“' },
  { id: 5, name: 'å¥¥ç‘ç™½', enName: 'Flat White', price: 28.00, isHot: true, category: 'å’–å•¡' },
  { id: 6, name: 'é»‘ç³–æ³¢æ³¢æ‹¿é“', enName: 'Brown Sugar Latte', price: 28.00, isHot: true, category: 'æ‹¿é“' },
  { id: 7, name: 'æ»¡æ¯ç™¾é¦™æœ', enName: 'Passion Fruit', price: 25.00, isHot: true, category: 'æ°´æœèŒ¶' },
  { id: 8, name: 'æ¤°å­å†°', enName: 'Coconut Ice', price: 28.00, isHot: true, category: 'ç‘çº³å†°' },
];

@Entry
@Component
struct MainApp {
  @State isSearchActive: boolean = false;
  @State currentTabIndex: number = 0;

  build() {
    Stack() {
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          HomePage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'ğŸ '))

        TabContent() {
          MenuPage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(1, 'èœå•', 'â˜•'))

        TabContent() {
          BagPage()
        }
        .tabBar(this.TabBuilder(2, 'è´­ç‰©è¢‹', 'ğŸ›ï¸'))

        TabContent() {
          MineView()
        }
        .tabBar(this.TabBuilder(3, 'æˆ‘çš„', 'ğŸ‘¤'))
      }
      .barPosition(BarPosition.End)
      .onChange((index) => {
        this.currentTabIndex = index;
      })

      if (this.isSearchActive) {
        SearchPage({
          onBack: () => {
            animateTo({ duration: 300 }, () => { this.isSearchActive = false; })
          }
        })
          .zIndex(999)
          .transition({ type: TransitionType.All, opacity: 0 })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder TabBuilder(index: number, title: string, iconEmoji: string) {
    Column() {
      Text(iconEmoji).fontSize(24).margin({ bottom: 4 })
        .opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(title).fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#0035AA' : '#999999')
    }
    .width('100%').height(50).justifyContent(FlexAlign.Center)
  }
}

// --- ç»„ä»¶ï¼šé¦–é¡µ ---
@Component
struct HomePage {
  onSearchClick: () => void = () => {};

  // åˆå§‹åŒ– Banner æ•°æ®
  @State banners: BannerItem[] = [];

  aboutToAppear() {
    this.fetchBanners();
  }

  async fetchBanners() {
    try {
      const res = await CoffeeApi.getBanner();
      if (res.code === 200 && res.data) {
        this.banners = res.data;
      }
    } catch (err) {
      console.error('[HomePage Error] Banner è·å–å¤±è´¥');
    }
  }

  build() {
    Column() {
      Row() {
        Column() {
          Text('ä¸‹åˆå¥½').fontSize(14).fontColor('#333')
          Text('User').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#0035AA')
        }
        .alignItems(HorizontalAlign.Start).margin({ right: 15 })

        Row() {
          Text('ğŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
          Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
        }
        .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18)
        .onClick(() => { this.onSearchClick(); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      Scroll() {
        Column() {
          if (this.banners.length > 0) {
            Swiper() {
              ForEach(this.banners, (item: BannerItem) => {
                Image(item.bannerImg)
                  .width('100%').height(200).backgroundColor('#F0F0F0')
                  .borderRadius(8).objectFit(ImageFit.Cover)
              }, (item: BannerItem) => item.pid)
            }
            .width('100%').height(200).autoPlay(true).indicator(true)
          } else {
            // å ä½å›¾
            Row().width('100%').height(200).backgroundColor('#F0F0F0').borderRadius(8)
          }

          Text('çŒœä½ å–œæ¬¢').fontSize(18).fontWeight(FontWeight.Bold).width('100%').padding(15)
          ProductGrid({ products: PRODUCT_DB })
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}

// --- ç»„ä»¶ï¼šè´­ç‰©è¢‹ ---
@Component
struct BagPage {
  build() {
    Column() {
      Row() {
        Text('< è¿”å›').fontSize(16).fontColor('#0035AA')
        Text('è´­ç‰©è¢‹').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).padding({right: 40})
      }
      .width('100%').height(50).padding({ left: 15, right: 15 })
      .backgroundColor(Color.White)

      Column() {
        Text('luckin coffee çš„æ–°é²œ').fontColor(Color.White).fontSize(14)
        Text('å–ä¸‹ç¬¬ä¸€å£ï¼Œä½ å°±æ‡‚äº†').fontColor(Color.White).fontSize(12).margin({top:5})
      }
      .width('100%').height(80).backgroundColor('#A89A8E').justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Start).padding({left: 20})

      Column() {
        Text('âœ–').fontSize(60).fontColor('#DDD').margin({ bottom: 20 })
        Text('è¯·å…ˆç™»å½•').fontSize(14).fontColor('#999').margin({ bottom: 30 })

        Button('å»ç™»å½•', { type: ButtonType.Normal })
          .width(120).height(40)
          .backgroundColor('#0035AA')
          .borderRadius(20)
          .fontSize(14)
          .onClick(() => {
            router.pushUrl({ url: 'pages/LoginPage' });
          })
      }
      .layoutWeight(1).width('100%').justifyContent(FlexAlign.Center)
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }
}

// --- ç»„ä»¶ï¼šæˆ‘çš„é¡µé¢ ---
@Component
struct MineView {
  build() {
    Column() {
      Stack({ alignContent: Alignment.BottomStart }) {
        Column().width('100%').height(200).backgroundColor('#333')

        Row() {
          Stack({ alignContent: Alignment.Center }) {
            Circle().width(60).height(60).fill(Color.White)
            Text('å¤´åƒ').fontSize(12)
          }.margin({ right: 15 })

          Column() {
            Text('User').fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ bottom: 5 })
            Text('Welcome back').fontSize(12).fontColor('#EEE')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%').padding({ left: 20, bottom: 30 })
      }
      .width('100%').height(200)

      Column() {
        this.MenuItem('ä¸ªäººèµ„æ–™', () => { router.pushUrl({ url: 'pages/UserInfoPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„è®¢å•', () => { router.pushUrl({ url: 'pages/MyOrderPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„æ”¶è—', () => { router.pushUrl({ url: 'pages/MyFavoritePage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('åœ°å€ç®¡ç†', () => { router.pushUrl({ url: 'pages/AddressListPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('å®‰å…¨ä¸­å¿ƒ', () => { router.pushUrl({ url: 'pages/SecurityPage' }) })
      }
      .width('100%').backgroundColor(Color.White).borderRadius({ topLeft: 12, topRight: 12 })
      .margin({ top: -15 }).padding({ top: 10, bottom: 10 })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  @Builder MenuItem(title: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor('#333')
      Text('>').fontSize(16).fontColor('#999')
    }
    .width('100%').height(55).justifyContent(FlexAlign.SpaceBetween).padding({ left: 20, right: 20 })
    .backgroundColor(Color.White).onClick(onClick)
  }
}

// --- ç»„ä»¶ï¼šæœç´¢é¡µ ---
@Component
struct SearchPage {
  onBack: () => void = () => {};
  @State searchText: string = '';
  @State searchHistory: string[] = ['æ‹¿é“', 'ç¾å¼'];
  @State searchResults: Product[] = [];

  build() {
    Column() {
      Row() {
        Text('<').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333').padding({ right: 10 }).onClick(() => this.onBack())
        TextInput({ placeholder: 'è¯·è¾“å…¥å’–å•¡åç§°', text: this.searchText })
          .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18).margin({ left: 10, right: 10 }).padding({ left: 15 })
          .enterKeyType(EnterKeyType.Search)
          .onChange((value) => { this.searchText = value; })
          .onSubmit(() => { this.performSearch(this.searchText); })

        Text('æœç´¢').fontSize(16).fontColor('#0035AA').onClick(() => { this.performSearch(this.searchText); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      if (this.searchResults.length === 0) {
        Column() {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.searchHistory, (item: string, index: number) => {
              Row() {
                Text(item).fontSize(14).fontColor('#666')
                Text('Ã—').fontSize(14).fontColor('#999').margin({ left: 5 }).onClick(() => { this.searchHistory.splice(index, 1); })
              }
              .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor('#F5F5F5').borderRadius(4).margin({ right: 10, bottom: 10 })
              .onClick(() => { this.searchText = item; this.performSearch(item); })
            })
          }
          .padding({ top: 10, bottom: 20 })
          if (this.searchHistory.length > 0) {
            Button('æ¸…é™¤æ‰€æœ‰æœç´¢å†å²', { type: ButtonType.Normal }).backgroundColor('#F0F0F0').fontColor('#999').fontSize(12).width(150).height(30).borderRadius(15).onClick(() => { this.searchHistory = []; })
          }
        }
        .width('100%').padding(15).alignItems(HorizontalAlign.Center)
      } else {
        Scroll() { ProductGrid({ products: this.searchResults }) }.layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  performSearch(keyword: string) {
    if (!keyword || keyword.trim() === '') { this.searchResults = []; return; }
    this.searchResults = PRODUCT_DB.filter(product => product.name.includes(keyword) || product.enName.toLowerCase().includes(keyword.toLowerCase()));
    if (!this.searchHistory.includes(keyword)) { this.searchHistory.unshift(keyword); }
  }
}

// --- ç»„ä»¶ï¼šå•†å“ç½‘æ ¼ (æ ¸å¿ƒä¿®å¤å¤„) ---
@Component
struct ProductGrid {
  // âœ… ä¿®å¤ï¼šå¿…é¡»ç»™ @Prop æä¾›ä¸€ä¸ªé»˜è®¤å€¼
  @Prop products: Product[] = [];

  build() {
    Grid() {
      ForEach(this.products, (item: Product) => {
        GridItem() {
          Column() {
            Stack({ alignContent: Alignment.TopStart }) {
              Column() { Text('â˜•').fontSize(40) }.width('100%').height(150).backgroundColor('#EEEEEE').justifyContent(FlexAlign.Center).borderRadius({ topLeft: 8, topRight: 8 })
              if (item.isHot) {
                Text('çƒ­å–').fontSize(10).fontColor(Color.White).backgroundColor('#FF4400').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius({ topLeft: 8, bottomRight: 8 })
              }
            }
            Column() {
              Text(item.name).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%')
              Text(item.enName).fontSize(12).fontColor('#999').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('100%').margin({ top: 2, bottom: 10 })
              Row() {
                Text(`Â¥${item.price.toFixed(2)}`).fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)
                Text('âŠ•').fontSize(24).fontColor('#0035AA')
                  .onClick(() => {
                    // å¯ä»¥åœ¨è¿™é‡Œè·³è½¬è¯¦æƒ…é¡µï¼Œæ³¨æ„ä¼ é€’ pid/id
                    router.pushUrl({
                      url: 'pages/ProductDetailPage',
                      params: { pid: item.id.toString() }
                    })
                  })
              }
              .width('100%').justifyContent(FlexAlign.SpaceBetween)
            }
            .padding(10).backgroundColor(Color.White)
          }
          .borderRadius(8).backgroundColor(Color.White).shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })
        }
      }, (item: Product) => item.id.toString())
    }
    .columnsTemplate('1fr 1fr').columnsGap(10).rowsGap(10).padding(10).width('100%').height('100%')
  }
}