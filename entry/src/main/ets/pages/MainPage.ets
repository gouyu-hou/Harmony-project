import router from '@ohos.router';
import { MenuPage } from './MenuPage';
import CoffeeApi, { BannerItem, ProductItem, UserInfo, ShopCartItem, ApiResponse,MyData } from '../api/CoffeeApi';
import promptAction from '@ohos.promptAction';

// --- æœ¬åœ°æ•°æ®æ¨¡å‹ ---
interface Product {
  id: string;
  name: string;
  enName: string;
  price: number;
  isHot?: boolean;
  category: string;
  smallImg?: string;
}

// 1. å®šä¹‰æ‰©å±•æ¥å£ï¼Œå¢åŠ é€‰ä¸­çŠ¶æ€ checked
interface ExtendedShopCartItem extends ShopCartItem {
  checked: boolean;
}

// æ¨¡æ‹Ÿæ•°æ®åº“
const PRODUCT_DB: Product[] = [
  { id: '1', name: 'ç„¦ç³–æ‹¿é“', enName: 'Caramel Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: '2', name: 'æ¦›æœæ‹¿é“', enName: 'Hazelnut Latte', price: 28.00, isHot: true, category: 'çƒ­å–æ¨è' },
  { id: '3', name: 'æ ‡å‡†ç¾å¼', enName: 'Americano', price: 22.00, isHot: false, category: 'å’–å•¡' },
  { id: '4', name: 'ç”Ÿæ¤°æ‹¿é“', enName: 'Coconut Latte', price: 29.00, isHot: true, category: 'æ‹¿é“' },
  { id: '5', name: 'å¥¥ç‘ç™½', enName: 'Flat White', price: 28.00, isHot: true, category: 'å’–å•¡' },
  { id: '6', name: 'é»‘ç³–æ³¢æ³¢æ‹¿é“', enName: 'Brown Sugar Latte', price: 28.00, isHot: true, category: 'æ‹¿é“' },
  { id: '7', name: 'æ»¡æ¯ç™¾é¦™æœ', enName: 'Passion Fruit', price: 25.00, isHot: true, category: 'æ°´æœèŒ¶' },
  { id: '8', name: 'æ¤°å­å†°', enName: 'Coconut Ice', price: 28.00, isHot: true, category: 'ç‘çº³å†°' },
];

@Entry
@Component
struct MainApp {
  @State isSearchActive: boolean = false;
  @State currentTabIndex: number = 0;

  // âœ…âœ…âœ… è¯·å°†è¿™æ®µä»£ç åŠ åœ¨è¿™é‡Œ (MainApp å†…éƒ¨)
  aboutToAppear() {
    const params = router.getParams() as Record<string, number>;
    if (params && params['index'] !== undefined) {
      this.currentTabIndex = params['index'];
    }
  }

  build() {
    Stack() {
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          HomePage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(0, 'é¦–é¡µ', $r('app.media.home'), $r('app.media.home_active')))

        TabContent() {
          MenuPage({
            onSearchClick: () => {
              animateTo({ duration: 300 }, () => { this.isSearchActive = true; })
            }
          })
        }
        .tabBar(this.TabBuilder(1, 'èœå•', $r('app.media.menu'), $r('app.media.menu_active')))

        TabContent() {
          BagPage({ currentIndex: this.currentTabIndex })
        }
        .tabBar(this.TabBuilder(2, 'è´­ç‰©è¢‹', $r('app.media.shopbag'), $r('app.media.shopbag_active')))

        TabContent() {
          MineView()
        }
        .tabBar(this.TabBuilder(3, 'æˆ‘çš„', $r('app.media.my'), $r('app.media.my_active')))
      }
      .barPosition(BarPosition.End)
      .onChange((index) => {
        this.currentTabIndex = index;
      })

      if (this.isSearchActive) {
        SearchPage({
          onBack: () => {
            animateTo({ duration: 300 }, () => { this.isSearchActive = false; })
          }
        })
          .zIndex(999)
          .transition({ type: TransitionType.All, opacity: 0 })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder TabBuilder(index: number, title: string, icon: Resource, activeIcon: Resource) {
    Column() {
      Image(this.currentTabIndex === index ? activeIcon : icon)
        .width(24)
        .height(24)
        .margin({ bottom: 4 })
        .objectFit(ImageFit.Contain) // ç¡®ä¿å›¾ç‰‡ä¸å¤±çœŸ

      Text(title)
        .fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#0035AA' : '#999999')
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
  }
}

// --- ç»„ä»¶ï¼šé¦–é¡µ ---
@Component
struct HomePage {
  onSearchClick: () => void = () => {};

  @StorageLink('userInfo') userInfoStr: string = '{}';

  get user(): UserInfo {
    const defaultUser: UserInfo = { userId: '', nickName: 'Guest', userImg: '' };
    if (!this.userInfoStr || this.userInfoStr === '{}') {
      return defaultUser;
    }
    try {
      const parsed = JSON.parse(this.userInfoStr) as UserInfo;
      return parsed ? parsed : defaultUser;
    } catch {
      return defaultUser;
    }
  }

  @State banners: BannerItem[] = [];
  @State hotProducts: Product[] = [];

  aboutToAppear() {


    this.fetchBanners();
    this.fetchHotProducts();
  }

  async fetchBanners() {
    try {
      const res = await CoffeeApi.getBanner();
      if (res.data && Array.isArray(res.data)) {
        this.banners = res.data;
      }
    } catch (err) {
      console.error('[HomePage] Banner è·å–å¤±è´¥');
    }
  }

  // âœ… ä¿®æ”¹åçš„ fetchHotProducts
  async fetchHotProducts() {
    console.info('ã€Debugã€‘å¼€å§‹è°ƒç”¨ getHotProducts æ¥å£...');
    try {
      const res = await CoffeeApi.getHotProducts();

      if (res && res.data && Array.isArray(res.data)) {
        this.hotProducts = res.data.map((item: ProductItem) => {
          return {
            id: item.pid,         // âŒ å»æ‰ parseInt()ï¼Œç›´æ¥èµ‹å€¼å­—ç¬¦ä¸²
            name: item.name,
            enName: item.enname,
            price: parseFloat(item.price), // ä»·æ ¼é€šå¸¸æ˜¯æ•°å­—å­—ç¬¦ä¸²ï¼Œä¿ç•™ parseFloat
            isHot: true,
            category: 'çƒ­å–æ¨è',
            smallImg: item.smallImg
          } as Product;
        });
        console.info('ã€Debugã€‘æ•°æ®è½¬æ¢æˆåŠŸï¼Œé¦–ä¸ªå•†å“ID:', this.hotProducts[0]?.id);
      }
    } catch (err) {
      console.error('ã€Debugã€‘çƒ­å–å•†å“è¯·æ±‚å¼‚å¸¸: ' + JSON.stringify(err));
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ  (ä¿æŒä¸å˜)
      Row() {
        Column() {
          Text('ä¸‹åˆå¥½').fontSize(14).fontColor('#333')
          Text(this.user?.nickName ?? 'Guest')
            .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#0035AA')
        }
        .alignItems(HorizontalAlign.Start).margin({ right: 15 })

        Row() {
          Text('ğŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
          Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
        }
        .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18)
        .onClick(() => { this.onSearchClick(); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      // ä½ç½®ï¼šHomePage ç»„ä»¶ -> build() -> Scroll() å†…éƒ¨
      Scroll() {
        Column() {
          // --- Banner è½®æ’­ä¿®æ”¹ ---
          if (this.banners.length > 0) {
            Swiper() {
              ForEach(this.banners, (item: BannerItem) => {
                Image(item.bannerImg)
                  .width('100%').height(200).backgroundColor('#F0F0F0')
                  .borderRadius(8).objectFit(ImageFit.Cover)
                // âœ… æ–°å¢ï¼šç‚¹å‡» Banner è·³è½¬è¯¦æƒ…é¡µ
                  .onClick(() => {
                    if (item.pid) {
                      router.pushUrl({
                        url: 'pages/ProductDetailPage',
                        params: { pid: item.pid }
                      })
                    }
                  })
              }, (item: BannerItem, index: number) => item.pid ? `${item.pid}` : `${index}`)
            }
            .width('100%').height(200).autoPlay(true).indicator(true)
          } else {
            Row().width('100%').height(200).backgroundColor('#F0F0F0').borderRadius(8)
          }

          Text('çŒœä½ å–œæ¬¢').fontSize(18).fontWeight(FontWeight.Bold).width('100%').padding(15)

          // åˆ—è¡¨æ¸²æŸ“ (ä¿æŒä¸å˜ï¼Œé€»è¾‘åœ¨ ProductGrid ä¸­ä¿®æ”¹)
          if (this.hotProducts.length > 0) {
            ProductGrid({ products: this.hotProducts })
          } else {
            Column() {
              LoadingProgress().width(40).height(40).color('#0035AA')
              Text('åŠ è½½æ•°æ®ä¸­...').fontSize(12).fontColor('#999').margin({ top: 10 })
            }.width('100%').padding(20).justifyContent(FlexAlign.Center)
          }
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}

// --- ç»„ä»¶ï¼šè´­ç‰©è¢‹ ---
// --- ç»„ä»¶ï¼šè´­ç‰©è¢‹ ---
@Component
struct BagPage {
  @StorageLink('token') token: string = '';
  // ä½¿ç”¨æ‰©å±•åçš„ç±»å‹ (ç¡®ä¿ä½ åœ¨æ–‡ä»¶é¡¶éƒ¨å®šä¹‰äº† interface ExtendedShopCartItem extends ShopCartItem { checked: boolean; })
  @State cartList: ExtendedShopCartItem[] = [];
  @State totalPrice: number = 0;
  @State isAllSelected: boolean = true;
  @State isEditMode: boolean = false; // ã€æ–°å¢ã€‘ç¼–è¾‘æ¨¡å¼çŠ¶æ€

  @Prop @Watch('onIndexChange') currentIndex: number = 0;
  @StorageLink('refreshCart') @Watch('onRefreshCartChange') shouldRefresh: boolean = false;

  onRefreshCartChange() {
    if (this.shouldRefresh) {
      this.fetchCartList();
      setTimeout(() => { this.shouldRefresh = false; }, 100);
    }
  }

  onIndexChange() {
    if (this.currentIndex === 2) {
      this.fetchCartList();
    }
  }

  aboutToAppear() {
    this.fetchCartList();
  }

  // --- æ•°æ®è¯·æ±‚ä¸é€»è¾‘å¤„ç† ---
  async fetchCartList() {
    if (!this.token) {
      this.cartList = [];
      this.totalPrice = 0;
      return;
    }
    try {
      const res = await CoffeeApi.getShopcartList(this.token);
      if (res.data && Array.isArray(res.data)) {
        let tempList: ExtendedShopCartItem[] = [];
        res.data.forEach((item) => {
          let extendedItem = item as ExtendedShopCartItem;
          extendedItem.checked = true;
          tempList.push(extendedItem);
        });
        this.cartList = tempList;
        this.updateAllSelectedState();
        this.calculateTotal();
      } else {
        this.cartList = [];
        this.totalPrice = 0;
      }
    } catch (err) {
      console.error('[BagPage] åˆ·æ–°è´­ç‰©è½¦å¤±è´¥:', JSON.stringify(err));
      this.cartList = [];
      this.totalPrice = 0;
    }
  }

  calculateTotal() {
    let total = 0;
    this.cartList.forEach((item) => {
      if (item.checked) {
        const price = typeof item.price === 'string' ? parseFloat(item.price) : item.price;
        total += price * item.count;
      }
    });
    this.totalPrice = total;
  }

  updateAllSelectedState() {
    if (this.cartList.length === 0) {
      this.isAllSelected = false;
    } else {
      this.isAllSelected = this.cartList.every(item => item.checked);
    }
  }

  toggleItemSelect(index: number) {
    this.cartList[index].checked = !this.cartList[index].checked;
    this.cartList = this.cartList.slice(); // è§¦å‘æ›´æ–°
    this.updateAllSelectedState();
    this.calculateTotal();
  }

  toggleSelectAll() {
    this.isAllSelected = !this.isAllSelected;
    this.cartList.forEach(item => {
      item.checked = this.isAllSelected;
    });
    this.cartList = this.cartList.slice();
    this.calculateTotal();
  }

  async handleCountChange(sid: string, newCount: number) {
    if (newCount < 1) return;
    const index = this.cartList.findIndex(item => item.sid === sid);
    if (index === -1) return;
    try {
      const res: ApiResponse<null> = await CoffeeApi.updateShopcartCount(this.token, sid, newCount);
      if (res.code === 6000 || res.code === 200 || res.code === '200') {
        this.cartList[index].count = newCount;
        this.cartList = this.cartList.slice();
        this.calculateTotal();
      } else {
        promptAction.showToast({ message: res.msg || 'ä¿®æ”¹å¤±è´¥' });
      }
    } catch (err) {
      console.error('ä¿®æ”¹æ•°é‡å¼‚å¸¸', JSON.stringify(err));
    }
  }

  async handleDelete(sid: string) {
    try {
      const res: ApiResponse<null> = await CoffeeApi.deleteShopcart(this.token, [sid]);
      if (res.code === 7000 || res.code === 6000 || res.code === 200 || res.code === '200' || res.msg === 'Success') {
        this.cartList = this.cartList.filter(item => item.sid !== sid);
        this.updateAllSelectedState();
        this.calculateTotal();
        promptAction.showToast({ message: 'å·²åˆ é™¤å•†å“' });
      } else {
        promptAction.showToast({ message: res.msg || 'åˆ é™¤å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'åˆ é™¤å¼‚å¸¸' });
    }
  }

  // æ‰¹é‡åˆ é™¤ï¼ˆé…åˆç¼–è¾‘æ¨¡å¼ï¼‰
  async handleBatchDelete() {
    const selectedSids = this.cartList.filter(item => item.checked).map(item => item.sid);
    if (selectedSids.length === 0) {
      promptAction.showToast({ message: 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å•†å“' });
      return;
    }
    try {
      const res: ApiResponse<null> = await CoffeeApi.deleteShopcart(this.token, selectedSids);
      if (res.code === 7000 || res.code === 6000 || res.code === 200 || res.code === '200' || res.msg === 'Success') {
        this.cartList = this.cartList.filter(item => !item.checked);
        this.updateAllSelectedState();
        this.calculateTotal();
        this.isEditMode = false; // åˆ é™¤åé€€å‡ºç¼–è¾‘æ¨¡å¼
        promptAction.showToast({ message: 'å·²æ‰¹é‡åˆ é™¤' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  @Builder SwipeDeleteMenu(sid: string) {
    Row() {
      Column() {
        Text('åˆ é™¤')
          .fontColor(Color.White)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
      }
      .width(70)
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#D22028')
      .borderRadius({ topRight: 12, bottomRight: 12 })
      .onClick(() => {
        this.handleDelete(sid);
      })
    }
    .padding({ left: 10 })
  }

  @Builder renderCartItem(item: ExtendedShopCartItem, index: number) {
    ListItem() {
      Row() {
        // å‹¾é€‰åœˆ
        Toggle({ type: ToggleType.Checkbox, isOn: item.checked })
          .selectedColor('#0035AA')
          .width(24)
          .height(24)
          .margin({ right: 10 })
          .onClick(() => {
            this.toggleItemSelect(index);
          })

        // å¡ç‰‡ä¸»ä½“
        Row() {
          Image(item.small_img)
            .width(90).height(90)
            .borderRadius(8).objectFit(ImageFit.Cover).backgroundColor('#F5F5F5')

          Column() {
            Text(item.name)
              .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
              .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')

            Text(item.rule)
              .fontSize(12).fontColor('#999').margin({ top: 4, bottom: 4 })
              .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')

            Blank()

            Row() {
              Text(`Â¥${item.price}`)
                .fontSize(18).fontColor('#D22028').fontWeight(FontWeight.Bold)

              Blank()

              // æ•°é‡åŠ å‡
              Row() {
                Text('ï¼')
                  .fontSize(14).fontColor('#0035AA').fontWeight(FontWeight.Bold)
                  .width(24).height(24).textAlign(TextAlign.Center)
                  .border({ width: 1, color: '#0035AA', radius: 12 })
                  .onClick(() => this.handleCountChange(item.sid, item.count - 1))

                Text(`${item.count}`)
                  .fontSize(14).fontColor('#333').margin({ left: 10, right: 10 })

                Text('ï¼‹')
                  .fontSize(16).fontColor(Color.White).backgroundColor('#0035AA')
                  .width(24).height(24).textAlign(TextAlign.Center).borderRadius(12)
                  .onClick(() => this.handleCountChange(item.sid, item.count + 1))
              }
            }
            .width('100%').alignItems(VerticalAlign.Center)
          }
          .layoutWeight(1).height(90).margin({ left: 10 }).alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
      }
      .width('100%').padding(12).backgroundColor(Color.White)
      .borderRadius(12).shadow({ radius: 4, color: '#0D000000', offsetY: 2 })
    }
    .margin({ bottom: 12 })
    .swipeAction({ end: this.SwipeDeleteMenu(item.sid) })
  }

  build() {
    Column() {
      // ---------------- ã€é¡¶éƒ¨åŒºåŸŸæ ¸å¿ƒä¿®æ”¹ã€‘ ----------------
      Stack({ alignContent: Alignment.Bottom }) {
        // 1. èƒŒæ™¯å›¾ (ä½œä¸º Header èƒŒæ™¯ï¼Œè°ƒæ•´åˆé€‚é«˜åº¦)
        Image($r('app.media.shopbag_bg'))
          .width('100%')          // å®¹å™¨å®½åº¦100%
          .height('auto')         // é«˜åº¦è‡ªé€‚åº”ï¼ˆå…³é”®ï¼šé¿å…æ‹‰ä¼¸ï¼Œä¿è¯æ¯”ä¾‹ï¼‰
          .objectFit(ImageFit.Contain) // å®Œæ•´å±•ç¤ºå›¾ç‰‡ï¼ˆä¸è£å‰ªï¼Œç•™ç™½å¡«å……ï¼‰
          .opacity(0.45)          // é€æ˜åº¦ä¿æŒä¸å˜
          .backgroundColor('#F0F8FF') // åº•è‰²ï¼ˆå›¾ç‰‡æœªè¦†ç›–çš„åŒºåŸŸä¼šæ˜¾ç¤ºè¿™ä¸ªé¢œè‰²ï¼‰

        // 2. å¯¼èˆªæ å†…å®¹ (è¿”å› | æ ‡é¢˜ | ç¼–è¾‘)
        Row() {

          // ä¸­é—´ï¼šæ ‡é¢˜
          Text('è´­ç‰©è¢‹')
            .fontSize(20)
            .fontColor('#33')
            .layoutWeight(1)
            .margin(
              {
                left:40,

              }
            )
            .textAlign(TextAlign.Center)

          // å³ä¾§ï¼šç¼–è¾‘æŒ‰é’®
          Row() {
            Text(this.isEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘')
              .fontSize(16)
              .fontColor('#333')
          }
          .width(50)
          .height('100%')
          .justifyContent(FlexAlign.End)
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            this.isEditMode = !this.isEditMode;
          })
        }
        .width('100%')
        .height(50) // å¯¼èˆªæ é«˜åº¦
        .padding({ left: 15, right: 15 })
        .margin({ bottom: 10 }) // ç¨å¾®ç¦»åº•ä¸€ç‚¹
      }
      .width('100%')
      .height(100) // æ•´ä½“å¤´éƒ¨é«˜åº¦ï¼ŒåŒ…å«çŠ¶æ€æ ç©ºé—´
      .backgroundColor(Color.White)
      .zIndex(1)
      // -----------------------------------------------------

      // åˆ—è¡¨å†…å®¹
      if (!this.token) {
        this.EmptyView('æ‚¨è¿˜æ²¡æœ‰ç™»å½•å“¦', 'å»ç™»å½•', () => router.pushUrl({ url: 'pages/LoginPage' }))
      } else if (this.cartList.length === 0) {
        this.EmptyView('è´­ç‰©è¢‹ç©ºç©ºå¦‚ä¹Ÿ', 'å»é€›é€›', () => {
          promptAction.showToast({ message: 'è¯·ç‚¹å‡»åº•éƒ¨èœå•è¿›è¡Œé€‰è´­' });
        })
      } else {
        List() {
          ForEach(this.cartList, (item: ExtendedShopCartItem, index: number) => {
            this.renderCartItem(item, index)
          }, (item: ExtendedShopCartItem) => `${item.sid}_${item.count}_${item.checked}`)
        }
        .layoutWeight(1)
        .width('100%')
        .padding({ left: 15, right: 15, top: 15 })

        // åº•éƒ¨ç»“ç®—/åˆ é™¤æ 
        Row() {
          // å…¨é€‰
          Row() {
            Toggle({ type: ToggleType.Checkbox, isOn: this.isAllSelected })
              .selectedColor('#0035AA')
              .onClick(() => { this.toggleSelectAll(); })
            Text('å…¨é€‰').fontSize(14).fontColor('#333').margin({ left: 5 })
          }.height('100%').alignItems(VerticalAlign.Center)

          // å³ä¾§æ“ä½œåŒº (æ ¹æ®æ˜¯å¦ç¼–è¾‘æ¨¡å¼å˜åŒ–)
          if (this.isEditMode) {
            // ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            Button(`åˆ é™¤(${this.cartList.filter(i => i.checked).length})`, { type: ButtonType.Normal })
              .width(100).height(40)
              .backgroundColor('#D22028') // çº¢è‰²åˆ é™¤
              .borderRadius(20)
              .onClick(() => {
                this.handleBatchDelete();
              })
          } else {
            // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºåˆè®¡å’Œç»“ç®—
            Row({ space: 15 }) {
              Column() {
                Text('åˆè®¡').fontSize(12).fontColor('#666')
                Row() {
                  Text('Â¥').fontSize(12).fontColor('#D22028').fontWeight(FontWeight.Bold).margin({ bottom: 2 })
                  Text(`${this.totalPrice.toFixed(2)}`).fontSize(20).fontColor('#D22028').fontWeight(FontWeight.Bold)
                }.alignItems(VerticalAlign.Bottom)
              }.alignItems(HorizontalAlign.End)

              Button(`å»ç»“ç®—(${this.cartList.filter(i => i.checked).length})`, { type: ButtonType.Normal })
                .width(120).height(40)
                .backgroundColor(this.totalPrice > 0 ? '#0035AA' : '#CCCCCC')
                .borderRadius(20)
                .enabled(this.totalPrice > 0)
                .onClick(() => {
                  const selectedSids = this.cartList.filter(item => item.checked).map(item => item.sid);
                  if (selectedSids.length === 0) return;
                  router.pushUrl({
                    url: 'pages/SettlementPage',
                    params: { sids: selectedSids, totalPrice: this.totalPrice }
                  })
                })
            }
          }
        }
        .width('100%').height(70).backgroundColor(Color.White)
        .padding({ left: 20, right: 20 })
        .justifyContent(FlexAlign.SpaceBetween)
        .shadow({ radius: 10, color: '#1A000000', offsetY: -4 })
      }
    }
    .width('100%').height('100%').backgroundColor('#F9F9F9')
  }

  @Builder EmptyView(text: string, btnText: string, action: () => void) {
    Column() {
      Image($r('app.media.shopbag_bg')).width(200).height(200).objectFit(ImageFit.Contain).opacity(0.8)
      Text(text).fontSize(14).fontColor('#999').margin({ top: 10 })
      Button(btnText, { type: ButtonType.Normal })
        .width(140).height(40).backgroundColor('#0035AA').borderRadius(20).margin({ top: 20 })
        .onClick(action)
    }.layoutWeight(1).justifyContent(FlexAlign.Center).width('100%')
  }
}

// ... MineView å’Œ SearchPage ä¿æŒä¸å˜ï¼Œè¯·ç¡®ä¿æ–‡ä»¶ååŠéƒ¨åˆ†åŒ…å«å®ƒä»¬ ...
// ä¸ºäº†ä»£ç å®Œæ•´æ€§ï¼Œè¿™é‡Œè¡¥å…¨å‰©ä½™éƒ¨åˆ†

// entry/src/main/ets/pages/MainPage.ets

// ... (å‰é¢çš„ä»£ç )

@Component
struct MineView {
  @StorageLink('token') token: string = '';
  @StorageLink('userInfo') userInfoStr: string = '{}';

  // å®šä¹‰çŠ¶æ€å˜é‡
  @State myData: MyData = { userBg: '' };

  // âœ…âœ…âœ… ä¿®æ”¹ 1ï¼šåŒæ—¶è°ƒç”¨ä¸¤ä¸ªæ¥å£
  aboutToAppear() {
    if (this.token) {
      this.fetchMyData();     // è·å–èƒŒæ™¯å›¾
      this.fetchUserInfo();   // è·å–æ˜µç§°ã€å¤´åƒã€ç­¾å
    }
  }

  // âœ…âœ…âœ… æ–°å¢æ–¹æ³•ï¼šè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å¹¶æ›´æ–°å…¨å±€ç¼“å­˜
  async fetchUserInfo() {
    try {
      const res = await CoffeeApi.getUserInfo(this.token);
      // åªè¦ code æ˜¯ 200ï¼Œå°±è¯´æ˜è·å–æˆåŠŸ
      if (res.code === 200 || res.code === '200') {
        if (res.data) {
          console.info('ã€Debugã€‘è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', res.data.nickName);
          // æ›´æ–° AppStorageï¼Œè¿™ä¼šè‡ªåŠ¨åˆ·æ–° this.user ä»¥åŠé¡µé¢ä¸Šçš„æ˜¾ç¤º
          AppStorage.SetOrCreate('userInfo', JSON.stringify(res.data));
        }
      }
    } catch (err) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', JSON.stringify(err));
    }
  }

  // è·å–èƒŒæ™¯å›¾çš„æ–¹æ³• (ä¿æŒä¸å˜)
  async fetchMyData() {
    console.info('ã€Debugã€‘å‡†å¤‡è°ƒç”¨ /findMy æ¥å£...');
    try {
      const res = await CoffeeApi.findMy(this.token);
      if (res.code === 200 || res.code === '200') {
        if (res.data) {
          this.myData = res.data;
        }
      }
    } catch (err) {
      console.error('ã€Debugã€‘/findMy æ¥å£å¼‚å¸¸:', JSON.stringify(err));
    }
  }

  // è®¡ç®—å±æ€§ (ä¿æŒä¸å˜)
  get user(): UserInfo {
    const defaultUser: UserInfo = { userId: '', nickName: '', userImg: '' };
    if (!this.userInfoStr || this.userInfoStr === '{}') {
      return defaultUser;
    }
    try {
      const parsed = JSON.parse(this.userInfoStr) as UserInfo;
      return parsed ? parsed : defaultUser;
    } catch {
      return defaultUser;
    }
  }

  build() {
    Column() {
      Stack({ alignContent: Alignment.BottomStart }) {

        // èƒŒæ™¯å›¾ (ä¿æŒä¸å˜)
        if (this.myData.userBg) {
          Image(this.myData.userBg)
            .width('100%').height(200).objectFit(ImageFit.Cover).backgroundColor('#333')
        } else {
          Column().width('100%').height(200).backgroundColor('#333')
        }

        Row() {
          Stack({ alignContent: Alignment.Center }) {
            // å¤´åƒï¼šä¼˜å…ˆç”¨ user.userImg (UserInfoæ¥å£æ›´å‡†)ï¼Œå…¶æ¬¡ç”¨ myData
            Image(this.token && (this.user?.userImg || this.myData.userImg) ? (this.user?.userImg || this.myData.userImg) : $r('app.media.home'))
              .width(60).height(60).borderRadius(30).backgroundColor(Color.White)
              .objectFit(ImageFit.Cover)
              .alt($r('app.media.home'))
          }.margin({ right: 15 })

          Column() {
            // âœ…âœ…âœ… ä¿®æ”¹ 2ï¼šæ˜µç§°æ˜¾ç¤ºé€»è¾‘
            // ä¼˜å…ˆå– user.nickName (fetchUserInfo æ›´æ–°çš„)ï¼Œå…¶æ¬¡å– myData.nickName
            Text(this.token ? (this.user?.nickName || this.myData.nickName || 'ç”¨æˆ·') : 'ç‚¹å‡»ç™»å½•')
              .fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ bottom: 5 })
              .onClick(() => {
                if (!this.token) router.pushUrl({ url: 'pages/LoginPage' });
              })

            // âœ…âœ…âœ… ä¿®æ”¹ 3ï¼šä¸ªæ€§ç­¾åæ˜¾ç¤ºé€»è¾‘
            // ä¼˜å…ˆå– user.desc
            Text(this.token ? (this.user?.desc || 'æ¬¢è¿å›æ¥') : 'ç™»å½•äº«å—æ›´å¤šæƒç›Š')
              .fontSize(12).fontColor('#EEE')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%').padding({ left: 20, bottom: 30 })
      }
      .width('100%').height(200)

      // ... ä¸‹é¢çš„èœå•ä»£ç ä¿æŒä¸å˜ ...
      Column() {
        this.MenuItem('ä¸ªäººèµ„æ–™', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/UserInfoPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„è®¢å•', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/MyOrderPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('æˆ‘çš„æ”¶è—', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/MyFavoritePage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('åœ°å€ç®¡ç†', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/AddressListPage' }) })
        Divider().color('#F5F5F5')
        this.MenuItem('å®‰å…¨ä¸­å¿ƒ', () => { if (this.checkLogin()) router.pushUrl({ url: 'pages/SecurityPage' }) })

        if (this.token) {
          Divider().color('#F5F5F5')
          Row() {
            Text('é€€å‡ºç™»å½•').fontSize(16).fontColor('#D22028')
          }
          .width('100%').height(55).justifyContent(FlexAlign.Center)
          .backgroundColor(Color.White)
          .onClick(() => {
            this.handleLogout();
          })
        }
      }
      .width('100%').backgroundColor(Color.White).borderRadius({ topLeft: 12, topRight: 12 })
      .margin({ top: -15 }).padding({ top: 10, bottom: 10 })
    }
    .width('100%').height('100%').backgroundColor('#F5F5F5')
  }

  // ... (MenuItem, checkLogin, handleLogout ç­‰æ–¹æ³•ä¿æŒä¸å˜)
  @Builder MenuItem(title: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor('#333')
      Text('>').fontSize(16).fontColor('#999')
    }
    .width('100%').height(55).justifyContent(FlexAlign.SpaceBetween).padding({ left: 20, right: 20 })
    .backgroundColor(Color.White).onClick(onClick)
  }

  checkLogin(): boolean {
    if (!this.token) {
      router.pushUrl({ url: 'pages/LoginPage' });
      return false;
    }
    return true;
  }

  handleLogout() {
    AlertDialog.show({
      title: 'æç¤º',
      message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
      secondaryButton: {
        value: 'é€€å‡º', fontColor: '#D22028',
        action: () => {
          AppStorage.SetOrCreate('token', '');
          AppStorage.SetOrCreate('userInfo', '{}');
          router.replaceUrl({ url: 'pages/LoginPage' });
        }
      }
    })
  }
}

// --- ç»„ä»¶ï¼šæœç´¢é¡µ ---
@Component
struct SearchPage {
  onBack: () => void = () => {};
  @State searchText: string = '';
  @State searchHistory: string[] = ['æ‹¿é“', 'ç¾å¼'];
  @State searchResults: Product[] = [];

  build() {
    Column() {
      Row() {
        Text('<').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333').padding({ right: 10 }).onClick(() => this.onBack())
        TextInput({ placeholder: 'è¯·è¾“å…¥å’–å•¡åç§°', text: this.searchText })
          .layoutWeight(1).height(35).backgroundColor('#F5F5F5').borderRadius(18).margin({ left: 10, right: 10 }).padding({ left: 15 })
          .enterKeyType(EnterKeyType.Search)
          .onChange((value) => { this.searchText = value; })
          .onSubmit(() => { this.performSearch(this.searchText); })

        Text('æœç´¢').fontSize(16).fontColor('#0035AA').onClick(() => { this.performSearch(this.searchText); })
      }
      .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).backgroundColor(Color.White)

      if (this.searchResults.length === 0) {
        Column() {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.searchHistory, (item: string, index: number) => {
              Row() {
                Text(item).fontSize(14).fontColor('#666')
                Text('Ã—').fontSize(14).fontColor('#999').margin({ left: 5 }).onClick(() => { this.searchHistory.splice(index, 1); })
              }
              .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor('#F5F5F5').borderRadius(4).margin({ right: 10, bottom: 10 })
              .onClick(() => { this.searchText = item; this.performSearch(item); })
            }, (item: string, index: number) => `${item}_${index}`)
          }
          .padding({ top: 10, bottom: 20 })
          if (this.searchHistory.length > 0) {
            Button('æ¸…é™¤æ‰€æœ‰æœç´¢å†å²', { type: ButtonType.Normal }).backgroundColor('#F0F0F0').fontColor('#999').fontSize(12).width(150).height(30).borderRadius(15).onClick(() => { this.searchHistory = []; })
          }
        }
        .width('100%').padding(15).alignItems(HorizontalAlign.Center)
      } else {
        Scroll() { ProductGrid({ products: this.searchResults }) }.layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  async performSearch(keyword: string) {
    if (!keyword || keyword.trim() === '') {
      this.searchResults = [];
      return;
    }

    // è®°å½•å†å²
    if (!this.searchHistory.includes(keyword)) {
      this.searchHistory.unshift(keyword);
    }

    // âœ… è°ƒç”¨ API æœç´¢
    try {
      const res = await CoffeeApi.search(keyword);
      // å…¼å®¹å­—ç¬¦ä¸²ç±»å‹çš„ code
      if ((res.code === 200 || res.code === '200') && res.data) {
        this.searchResults = res.data.map((item: ProductItem): Product => {
          return {
            id: item.pid,
            name: item.name,
            enName: item.enname,
            price: parseFloat(item.price),
            smallImg: item.smallImg,
            category: 'Search',
            isHot: false
          };
        });
      } else {
        this.searchResults = [];
      }
    } catch (err) {
      console.error('æœç´¢å¤±è´¥');
      this.searchResults = [];
    }
  }
}

// --- ç»„ä»¶ï¼šå•†å“ç½‘æ ¼ ---
// --- ç»„ä»¶ï¼šå•†å“ç½‘æ ¼ ---
// ä½ç½®ï¼šæ–‡ä»¶æœ€åº•éƒ¨
@Component
struct ProductGrid {
  @Prop products: Product[] = [];

  build() {
    // âœ… ä¿®æ”¹1ï¼šä½¿ç”¨ Flex æ›¿æ¢ Gridï¼Œè§£å†³æ˜¾ç¤ºä¸å…¨é—®é¢˜
    Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
      ForEach(this.products, (item: Product) => {
        Column() {
          // 1. å›¾ç‰‡éƒ¨åˆ†
          Stack({ alignContent: Alignment.TopStart }) {
            Image(item.smallImg)
              .width('100%')
              .height(150)
              .objectFit(ImageFit.Contain)
              .backgroundColor('#F9F9F9')
              .borderRadius({ topLeft: 8, topRight: 8 })
              .alt($r('app.media.shopbag_bg'))

            if (item.isHot) {
              Text('çƒ­å–')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#FF4400')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius({ topLeft: 8, bottomRight: 8 })
            }
          }

          // 2. æ–‡å­—ä¸ä»·æ ¼éƒ¨åˆ†
          Column() {
            Text(item.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')

            Text(item.enName)
              .fontSize(12)
              .fontColor('#999')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')
              .margin({ top: 2, bottom: 10 })

            Row() {
              Text(`Â¥${item.price.toFixed(2)}`)
                .fontSize(16)
                .fontColor('#D22028')
                .fontWeight(FontWeight.Bold)

              // åªæ˜¯è§†è§‰ç¬¦å·ï¼Œç‚¹å‡»äº‹ä»¶å·²æå‡åˆ°æ•´ä¸ªå¡ç‰‡
              Text('âŠ•')
                .fontSize(24)
                .fontColor('#0035AA')
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)
          }
          .padding(10).backgroundColor(Color.White)
        }
        .width('48%') // è®¾ç½®å®½åº¦é€‚é…ä¸¤åˆ—å¸ƒå±€
        .borderRadius(8)
        .backgroundColor(Color.White)
        .margin({ bottom: 10 })
        .shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })
        // âœ… ä¿®æ”¹2ï¼šå°†ç‚¹å‡»äº‹ä»¶ç»‘å®šåœ¨æ•´ä¸ª Item (Column) ä¸Š
        .onClick(() => {
          router.pushUrl({
            url: 'pages/ProductDetailPage',
            params: { pid: item.id }
          })
        })
      }, (item: Product) => `${item.id}`)
    }
    .width('100%')
    .padding(10)
    // æ³¨æ„ï¼šä¸è¦è®¾ç½® .height('100%')ï¼Œè®©å†…å®¹è‡ªåŠ¨æ’‘å¼€
  }
}