// entry/src/main/ets/pages/MenuPage.ets
import CoffeeApi, { CategoryItem, ProductItem } from '../api/CoffeeApi';
import router from '@ohos.router';
@Component
export struct MenuPage {
  onSearchClick: () => void = () => {};

  // æ•°æ®æº
  @State categories: CategoryItem[] = []; // å·¦ä¾§åˆ†ç±»
  @State products: ProductItem[] = [];    // å³ä¾§å•†å“
  @State selectedIndex: number = 0;       // å½“å‰é€‰ä¸­çš„åˆ†ç±»ç´¢å¼•
  @State isLoading: boolean = false;      // åŠ è½½çŠ¶æ€

  aboutToAppear() {
    this.initMenuData();
  }

  // åˆå§‹åŒ–ï¼šè·å–åˆ†ç±»åˆ—è¡¨
  async initMenuData() {
    this.isLoading = true;
    try {
      const res = await CoffeeApi.getTypes();
      if (res.code === 200 && res.data && res.data.length > 0) {
        this.categories = res.data;
        // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»çš„å•†å“
        await this.loadProducts(this.categories[0].type);
      }
    } catch (err) {
      console.error('åˆ†ç±»åŠ è½½å¤±è´¥, è¯·æ£€æŸ¥ç½‘ç»œæˆ–API');
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ‡æ¢åˆ†ç±»ï¼šåŠ è½½å¯¹åº”å•†å“
  async loadProducts(type: string) {
    // åˆ‡æ¢æ—¶å…ˆè®©åˆ—è¡¨ç©ºä¸€ä¸‹ï¼Œæˆ–è€…æ˜¾ç¤ºLoadingï¼Œé˜²æ­¢è§†è§‰æ··æ·†
    this.products = [];
    try {
      const res = await CoffeeApi.getProductsByType(type);
      if (res.code === 200 && res.data) {
        this.products = res.data;
      }
    } catch (err) {
      console.error(`å•†å“åŠ è½½å¤±è´¥: ${type}`);
    }
  }

  build() {
    Column() {
      // 1. æœç´¢æ¡† (ä¿æŒä¸å˜)
      Row() {
        Text('ğŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
        Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
      }
      .width('92%').height(35).backgroundColor('#F5F5F5').borderRadius(18)
      .margin({ top: 10, bottom: 10 }).padding({ left: 10 })
      .onClick(() => { this.onSearchClick(); })

      // 2. ä¸»ä½“å†…å®¹
      Row() {
        // 2.1 å·¦ä¾§åˆ†ç±»æ 
        List() {
          ForEach(this.categories, (item: CategoryItem, index: number) => {
            ListItem() {
              Row() {
                // é€‰ä¸­æ—¶çš„å·¦ä¾§è“æ¡
                if (this.selectedIndex === index) {
                  Divider().vertical(true).strokeWidth(4).color('#0035AA').height(20).borderRadius(2)
                }
                Text(item.typeDesc)
                  .fontSize(14)
                  .fontColor(this.selectedIndex === index ? '#333' : '#666')
                  .fontWeight(this.selectedIndex === index ? FontWeight.Bold : FontWeight.Normal)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
              }
              .width('100%').height(50)
              .backgroundColor(this.selectedIndex === index ? Color.White : '#F9F9F9')
              .onClick(() => {
                if (this.selectedIndex !== index) {
                  this.selectedIndex = index;
                  this.loadProducts(item.type); // ç‚¹å‡»åˆ‡æ¢æ•°æ®
                }
              })
            }
          }, (item: CategoryItem) => item.type)
        }
        .width('25%').height('100%').backgroundColor('#F9F9F9')

        // 2.2 å³ä¾§å•†å“æ 
        Stack() {
          if (this.isLoading && this.products.length === 0) {
            LoadingProgress().width(40).height(40).color('#0035AA')
          } else {
            List() {
              ForEach(this.products, (item: ProductItem) => {
                ListItem() {
                  this.GoodsItemBuilder(item)
                }
              }, (item: ProductItem) => item.pid)
            }
            .layoutWeight(1).width('100%').height('100%')
          }
        }
        .width('75%').height('100%').backgroundColor(Color.White)
      }
      .layoutWeight(1).width('100%')
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  @Builder GoodsItemBuilder(item: ProductItem) {
    Row() {
      // å›¾ç‰‡
      Image(item.smallImg)
        .width(80).height(80)
        .borderRadius(4)
        .objectFit(ImageFit.Cover)
        .backgroundColor('#F5F5F5') // å›¾ç‰‡åŠ è½½å‰çš„åº•è‰²
        .margin({ right: 10 })

      // ä¿¡æ¯
      Column() {
        Text(item.name)
          .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
          .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(item.enname)
          .fontSize(12).fontColor('#999')
          .margin({ top: 2, bottom: 15 })
          .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(`Â¥${item.price}`)
            .fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)

          Text('âŠ•')
            .fontSize(24).fontColor('#0035AA')
            .onClick(() => {
              // è¿™é‡Œé¢„ç•™åŠ è´­é€»è¾‘
              console.info(`ç‚¹å‡»äº†åŠ è´­: ${item.name}`);
            })
        }
        .width('100%').justifyContent(FlexAlign.SpaceBetween)
      }
      .layoutWeight(1).alignItems(HorizontalAlign.Start)
    }
    .padding(10).width('100%')
    .onClick(() => {
      router.pushUrl({
        url: 'pages/ProductDetailPage',
        params: {
          pid: item.pid // ä¼ é€’ pid å‚æ•°
        }
      });
    })
  }
}