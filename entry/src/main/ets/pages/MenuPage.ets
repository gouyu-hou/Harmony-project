import CoffeeApi, { CategoryItem, ProductItem } from '../api/CoffeeApi';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Component
export struct MenuPage {
  onSearchClick: () => void = () => {};

  @State categories: CategoryItem[] = [];
  @State products: ProductItem[] = [];
  @State selectedIndex: number = 0;
  @State isLoading: boolean = false;

  @StorageLink('token') token: string = '';
  @StorageLink('refreshCart') refreshCart: boolean = false;

  aboutToAppear() {
    this.initMenuData();
  }

  async initMenuData() {
    this.isLoading = true;
    try {
      const res = await CoffeeApi.getTypes();
      if ((res.code === 200 || res.code === '200') && res.data && res.data.length > 0) {
        this.categories = res.data;
        await this.loadProducts(this.categories[0].type);
      }
    } catch (err) {
      console.error('åˆ†ç±»åŠ è½½å¤±è´¥, è¯·æ£€æŸ¥ç½‘ç»œæˆ–API');
    } finally {
      this.isLoading = false;
    }
  }

  async loadProducts(type: string) {
    this.products = [];
    try {
      const res = await CoffeeApi.getProductsByType(type);
      if ((res.code === 200 || res.code === '200') && res.data) {
        this.products = res.data;
      }
    } catch (err) {
      console.error(`å•†å“åŠ è½½å¤±è´¥: ${type}`);
    }
  }

  async addToCart(item: ProductItem) {
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.pushUrl({ url: 'pages/LoginPage' });
      return;
    }

    try {
      const res = await CoffeeApi.addShopcart(this.token, item.pid, 1, 'é»˜è®¤');
      if (res.code === 200 || res.code === '200') {
        promptAction.showToast({ message: 'å·²åŠ å…¥è´­ç‰©è½¦' });
        this.refreshCart = true;
      } else {
        promptAction.showToast({ message: res.msg || 'åŠ å…¥å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸' });
    }
  }

  build() {
    Column() {
      // 1. æœç´¢æ¡† (ä¿æŒä¸å˜)
      Row() {
        Text('ðŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
        Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
      }
      .width('92%').height(35).backgroundColor('#F5F5F5').borderRadius(18)
      .margin({ top: 10, bottom: 10 }).padding({ left: 10 })
      .onClick(() => { this.onSearchClick(); })

      // 2. ä¸»ä½“å†…å®¹
      Row() {
        // å·¦ä¾§åˆ†ç±» (ä¿æŒä¸å˜)
        List() {
          ForEach(this.categories, (item: CategoryItem, index: number) => {
            ListItem() {
              Row() {
                if (this.selectedIndex === index) {
                  Divider().vertical(true).strokeWidth(4).color('#0035AA').height(20).borderRadius(2)
                }
                Text(item.typeDesc)
                  .fontSize(14)
                  .fontColor(this.selectedIndex === index ? '#333' : '#666')
                  .fontWeight(this.selectedIndex === index ? FontWeight.Bold : FontWeight.Normal)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
              }
              .width('100%').height(50)
              .backgroundColor(this.selectedIndex === index ? Color.White : '#F9F9F9')
              .onClick(() => {
                if (this.selectedIndex !== index) {
                  this.selectedIndex = index;
                  this.loadProducts(item.type);
                }
              })
            }
          }, (item: CategoryItem) => item.type)
        }
        .width('25%').height('100%').backgroundColor('#F9F9F9')

        // å³ä¾§å•†å“ (UIå˜æ›´åŒºåŸŸ)
        Stack() {
          if (this.isLoading && this.products.length === 0) {
            LoadingProgress().width(40).height(40).color('#0035AA')
          } else {
            // âœ… ä¿®æ”¹ç‚¹ 1: å°† List æ›¿æ¢ä¸º Grid
            Grid() {
              ForEach(this.products, (item: ProductItem) => {
                GridItem() {
                  this.GoodsItemBuilder(item)
                }
              }, (item: ProductItem) => item.pid)
            }
            .columnsTemplate('1fr 1fr') // âœ… å…³é”®ï¼šè®¾ç½®ä¸¤åˆ—ï¼Œæ¯”ä¾‹ 1:1
            .rowsGap(10)     // è¡Œé—´è·
            .columnsGap(10)  // åˆ—é—´è·
            .padding(10)     // æ•´ä½“å†…è¾¹è·
            .layoutWeight(1)
            .width('100%')
            .height('100%')
            .scrollBar(BarState.Off)
          }
        }
        // èƒŒæ™¯è®¾ä¸ºæµ…ç°ï¼Œè®©ç™½è‰²å¡ç‰‡æ›´æ˜Žæ˜¾
        .width('75%').height('100%').backgroundColor('#F5F5F5')
      }
      .layoutWeight(1).width('100%')
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  // âœ… ä¿®æ”¹ç‚¹ 2: é‡æ–°è®¾è®¡å¡ç‰‡æ ·å¼ (ç”± Row æ”¹ä¸º Column)
  @Builder GoodsItemBuilder(item: ProductItem) {
    Column() {
      // å›¾ç‰‡åŒºåŸŸ
      Image(item.smallImg)
        .width('100%') // å æ»¡å¡ç‰‡å®½åº¦
        .height(110)   // è®¾å®šå›ºå®šé«˜åº¦
        .objectFit(ImageFit.Cover)
        .borderRadius({ topLeft: 8, topRight: 8 }) // åªæœ‰ä¸Šé¢ä¸¤ä¸ªè§’æ˜¯åœ†è§’
        .backgroundColor('#EEEEEE')

      // å†…å®¹åŒºåŸŸ
      Column() {
        Text(item.name)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 5 })

        Text(item.enname)
          .fontSize(10)
          .fontColor('#999')
          .margin({ top: 2, bottom: 8 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // ä»·æ ¼å’ŒåŠ è´­æŒ‰é’®
        Row() {
          Text(`Â¥${item.price}`)
            .fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)

          Text('âŠ•')
            .fontSize(24).fontColor('#0035AA')
            .onClick((event: ClickEvent) => {
              this.addToCart(item);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween) // ä¸¤ç«¯å¯¹é½
        .alignItems(VerticalAlign.Center)
      }
      .padding(8)
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(8)
    .shadow({ radius: 4, color: '#1A000000', offsetY: 2 }) // å¢žåŠ ä¸€ç‚¹é˜´å½±è®©å®ƒåƒå¡ç‰‡
    .onClick(() => {
      router.pushUrl({
        url: 'pages/ProductDetailPage',
        params: { pid: item.pid }
      });
    })
  }
}