import CoffeeApi, { CategoryItem, ProductItem } from '../api/CoffeeApi';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction'; // âœ… æ–°å¢žï¼šå¼•å…¥å¼¹çª—å·¥å…·

@Component
export struct MenuPage {
  onSearchClick: () => void = () => {};

  @State categories: CategoryItem[] = [];
  @State products: ProductItem[] = [];
  @State selectedIndex: number = 0;
  @State isLoading: boolean = false;

  // âœ… æ–°å¢žï¼šèŽ·å– Token å’Œ è´­ç‰©è½¦åˆ·æ–°æŽ§åˆ¶
  @StorageLink('token') token: string = '';
  @StorageLink('refreshCart') refreshCart: boolean = false;

  aboutToAppear() {
    this.initMenuData();
  }

  async initMenuData() {
    this.isLoading = true;
    try {
      const res = await CoffeeApi.getTypes();
      if ((res.code === 200 || res.code === '200') && res.data && res.data.length > 0) {
        this.categories = res.data;
        await this.loadProducts(this.categories[0].type);
      }
    } catch (err) {
      console.error('åˆ†ç±»åŠ è½½å¤±è´¥, è¯·æ£€æŸ¥ç½‘ç»œæˆ–API');
    } finally {
      this.isLoading = false;
    }
  }

  async loadProducts(type: string) {
    this.products = [];
    try {
      const res = await CoffeeApi.getProductsByType(type);
      if ((res.code === 200 || res.code === '200') && res.data) {
        this.products = res.data;
      }
    } catch (err) {
      console.error(`å•†å“åŠ è½½å¤±è´¥: ${type}`);
    }
  }

  // âœ… æ–°å¢žï¼šåŠ å…¥è´­ç‰©è½¦é€»è¾‘
  async addToCart(item: ProductItem) {
    // 1. æ£€æŸ¥ç™»å½•
    if (!this.token) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.pushUrl({ url: 'pages/LoginPage' });
      return;
    }

    try {
      // 2. è°ƒç”¨æŽ¥å£
      // æ³¨æ„ï¼šåˆ—è¡¨é¡µå¿«é€ŸåŠ è´­é€šå¸¸ä½¿ç”¨é»˜è®¤è§„æ ¼ï¼Œè¿™é‡Œä¼ å‚ "é»˜è®¤"
      // å¦‚æžœä½ çš„ä¸šåŠ¡é€»è¾‘å¼ºåˆ¶å¿…é¡»é€‰è§„æ ¼ï¼Œåˆ™è¿™é‡Œåº”è¯¥å¼¹çª—ï¼Œè€Œä¸æ˜¯ç›´æŽ¥è°ƒç”¨ API
      const res = await CoffeeApi.addShopcart(this.token, item.pid, 1, 'é»˜è®¤');

      if (res.code === 200 || res.code === '200') {
        promptAction.showToast({ message: 'å·²åŠ å…¥è´­ç‰©è½¦' });
        // 3. è§¦å‘å…¨å±€åˆ·æ–° (é€šçŸ¥è´­ç‰©è½¦é¡µé¢æ›´æ–°)
        this.refreshCart = true;
      } else {
        promptAction.showToast({ message: res.msg || 'åŠ å…¥å¤±è´¥' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸' });
    }
  }

  build() {
    Column() {
      // 1. æœç´¢æ¡† (ä¿æŒä¸å˜)
      Row() {
        Text('ðŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
        Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
      }
      .width('92%').height(35).backgroundColor('#F5F5F5').borderRadius(18)
      .margin({ top: 10, bottom: 10 }).padding({ left: 10 })
      .onClick(() => { this.onSearchClick(); })

      // 2. ä¸»ä½“å†…å®¹
      Row() {
        // å·¦ä¾§åˆ†ç±» (ä¿æŒä¸å˜)
        List() {
          ForEach(this.categories, (item: CategoryItem, index: number) => {
            ListItem() {
              Row() {
                if (this.selectedIndex === index) {
                  Divider().vertical(true).strokeWidth(4).color('#0035AA').height(20).borderRadius(2)
                }
                Text(item.typeDesc)
                  .fontSize(14)
                  .fontColor(this.selectedIndex === index ? '#333' : '#666')
                  .fontWeight(this.selectedIndex === index ? FontWeight.Bold : FontWeight.Normal)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
              }
              .width('100%').height(50)
              .backgroundColor(this.selectedIndex === index ? Color.White : '#F9F9F9')
              .onClick(() => {
                if (this.selectedIndex !== index) {
                  this.selectedIndex = index;
                  this.loadProducts(item.type);
                }
              })
            }
          }, (item: CategoryItem) => item.type)
        }
        .width('25%').height('100%').backgroundColor('#F9F9F9')

        // å³ä¾§å•†å“
        Stack() {
          if (this.isLoading && this.products.length === 0) {
            LoadingProgress().width(40).height(40).color('#0035AA')
          } else {
            List() {
              ForEach(this.products, (item: ProductItem) => {
                ListItem() {
                  this.GoodsItemBuilder(item)
                }
              }, (item: ProductItem) => item.pid)
            }
            .layoutWeight(1).width('100%').height('100%')
          }
        }
        .width('75%').height('100%').backgroundColor(Color.White)
      }
      .layoutWeight(1).width('100%')
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  @Builder GoodsItemBuilder(item: ProductItem) {
    Row() {
      Image(item.smallImg)
        .width(80).height(80)
        .borderRadius(4)
        .objectFit(ImageFit.Cover)
        .backgroundColor('#F5F5F5')
        .margin({ right: 10 })

      Column() {
        Text(item.name)
          .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
          .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(item.enname)
          .fontSize(12).fontColor('#999')
          .margin({ top: 2, bottom: 15 })
          .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(`Â¥${item.price}`)
            .fontSize(16).fontColor('#D22028').fontWeight(FontWeight.Bold)

          // âœ… ä¿®æ”¹ç‚¹ï¼šç‚¹å‡»åŠ å·è°ƒç”¨ addToCart
          Text('âŠ•')
            .fontSize(24).fontColor('#0035AA')
            .onClick((event: ClickEvent) => {
              // é˜»æ­¢äº‹ä»¶å†’æ³¡ (å¦‚æžœéœ€è¦é˜²æ­¢è§¦å‘è·³è½¬è¯¦æƒ…é¡µ)
              // event.stopPropagation(); // ArkTS ä¸­è§†ç‰ˆæœ¬æ”¯æŒæƒ…å†µï¼Œä¸€èˆ¬ä¸ç”¨å†™ï¼ŒonClické»˜è®¤æ•èŽ·

              this.addToCart(item);
            })
        }
        .width('100%').justifyContent(FlexAlign.SpaceBetween)
      }
      .layoutWeight(1).alignItems(HorizontalAlign.Start)
    }
    .padding(10).width('100%')
    .onClick(() => {
      // ç‚¹å‡»æ•´è¡Œè·³è½¬è¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/ProductDetailPage',
        params: { pid: item.pid }
      });
    })
  }
}