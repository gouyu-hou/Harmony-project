import http from '@ohos.net.http';

// --- 1. æ•°æ®æŽ¥å£å®šä¹‰ ---
interface MenuItem {
  id: number;
  name: string;
  price: string;
  image?: string;
  description?: string;
  isHot?: boolean; // æ ‡è®°æ˜¯å¦ä¸ºçƒ­å–
}

interface MenuCategory {
  title: string;
  goods: MenuItem[];
}

interface ApiResponse {
  code: number;
  msg: string;
  data: MenuCategory[];
}

// --- 2. æœ¬åœ°ä¿åº•æ•°æ® (å½“æŽ¥å£æŒ‚äº†æˆ–æ²¡ç½‘æ—¶æ˜¾ç¤ºè¿™ä¸ª) ---
const LOCAL_MOCK_DATA: MenuCategory[] = [
  {
    title: 'çƒ­å–æŽ¨è',
    goods: [
      { id: 1, name: 'ç„¦ç³–æ‹¿é“', price: '28.00', description: 'Caramel Latte | ç„¦ç³–é£Žå‘³ï¼Œç”œèœœæš–å¿ƒ', isHot: true },
      { id: 2, name: 'æ¦›æžœæ‹¿é“', price: '28.00', description: 'Hazelnut Latte | æ¦›æžœæµ“é¦™ï¼Œå›žå‘³æ— ç©·', isHot: true },
      { id: 3, name: 'å¥¥ç‘žç™½', price: '28.00', description: 'Flat White | å¥¶æ³¡ç»†è…»ï¼Œå’–é¦™æµ“éƒ', isHot: true },
      { id: 4, name: 'é»‘ç³–æ³¢æ³¢æ‹¿é“', price: '28.00', description: 'Brown Sugar Bubble Latte | Qå¼¹æ³¢æ³¢', isHot: true },
      { id: 5, name: 'æ»¡æ¯ç™¾é¦™æžœ', price: '25.00', description: 'Passion Fruit | é…¸ç”œç™¾é¦™æžœï¼Œç»´Cæ»¡æ»¡', isHot: true },
      { id: 6, name: 'æ¤°å­å†°', price: '28.00', description: 'Coconut Ice | æ¸…çˆ½æ¤°é¦™ï¼Œå†°å‡‰ä¸€å¤', isHot: true }
    ]
  },
  {
    title: 'æ‹¿é“',
    goods: [
      { id: 1, name: 'ç„¦ç³–æ‹¿é“', price: '28.00', description: 'Caramel Latte', isHot: true },
      { id: 2, name: 'æ¦›æžœæ‹¿é“', price: '28.00', description: 'Hazelnut Latte', isHot: true },
      { id: 4, name: 'é»‘ç³–æ³¢æ³¢æ‹¿é“', price: '28.00', description: 'Brown Sugar Bubble Latte', isHot: true },
      { id: 10, name: 'ç”Ÿæ¤°æ‹¿é“', price: '29.00', description: 'Coconut Latte | äººæ°”çˆ†æ¬¾', isHot: true },
      { id: 11, name: 'åŽšä¹³æ‹¿é“', price: '28.00', description: 'Rich Milk Latte', isHot: false }
    ]
  },
  {
    title: 'å’–å•¡',
    goods: [
      { id: 3, name: 'å¥¥ç‘žç™½', price: '28.00', description: 'Flat White', isHot: true },
      { id: 12, name: 'æ ‡å‡†ç¾Žå¼', price: '22.00', description: 'Americano | ç»å…¸é»‘å’–', isHot: false },
      { id: 13, name: 'å¡å¸ƒå¥‡è¯º', price: '24.00', description: 'Cappuccino', isHot: false },
      { id: 14, name: 'æ‘©å¡', price: '27.00', description: 'Mocha', isHot: false }
    ]
  },
  {
    title: 'ç‘žçº³å†°',
    goods: [
      { id: 6, name: 'æ¤°å­å†°', price: '28.00', description: 'Coconut Ice', isHot: true },
      { id: 15, name: 'å·§å…‹åŠ›ç‘žçº³å†°', price: '27.00', description: 'Chocolate Ice', isHot: false },
      { id: 16, name: 'æŠ¹èŒ¶ç‘žçº³å†°', price: '27.00', description: 'Matcha Ice', isHot: false }
    ]
  },
  {
    title: 'æ°´æžœèŒ¶',
    goods: [
      { id: 5, name: 'æ»¡æ¯ç™¾é¦™æžœ', price: '25.00', description: 'Passion Fruit', isHot: true },
      { id: 17, name: 'æ¡ƒæ¡ƒå†°', price: '26.00', description: 'Peach Ice', isHot: false }
    ]
  }
];
@Component
export struct MenuPage {
  onSearchClick: () => void = () => {};

  @State categoryList: MenuCategory[] = [];
  @State selectedIndex: number = 0;
  @State isLoading: boolean = true;

  aboutToAppear() {
    this.fetchMenuData();
  }

  async fetchMenuData() {
    let httpRequest = http.createHttp();

    try {
      console.info('æ­£åœ¨è¯·æ±‚èœå•æŽ¥å£...');
      let response = await httpRequest.request(
        'https://apis.netstart.cn/coffee/menu',
        {
          method: http.RequestMethod.GET,
          expectDataType: http.HttpDataType.OBJECT,
          readTimeout: 5000, // 5ç§’è¶…æ—¶
          connectTimeout: 5000
        }
      );

      if (response.responseCode === 200) {
        const res = response.result as ApiResponse;
        if (res.code === 200 && res.data && res.data.length > 0) {
          console.info('ç½‘ç»œæ•°æ®è¯·æ±‚æˆåŠŸ');
          this.categoryList = res.data;
          this.isLoading = false;
        } else {
          throw new Error('æŽ¥å£æ•°æ®ä¸ºç©º');
        }
      } else {
        throw new Error('HTTPçŠ¶æ€ç é”™è¯¯');
      }

    } catch (err) {
      console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼ŒåŠ è½½æœ¬åœ°ä¿åº•æ•°æ®: ' + JSON.stringify(err));
      // ã€å…³é”®é€»è¾‘ã€‘ï¼šç½‘ç»œå¤±è´¥æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
      this.categoryList = LOCAL_MOCK_DATA;
      this.isLoading = false;
    } finally {
      httpRequest.destroy();
    }
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æœç´¢æ¡†
      Row() {
        Text('ðŸ”').fontSize(14).fontColor('#999').margin({ left: 10, right: 5 })
        Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯').fontSize(14).fontColor('#CCC')
      }
      .width('92%')
      .height(35)
      .backgroundColor('#F5F5F5')
      .borderRadius(18)
      .margin({ top: 10, bottom: 10 })
      .padding({ left: 10 })
      .onClick(() => {
        this.onSearchClick();
      })

      // 2. å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40).color('#0035AA')
          Text('æ­£åœ¨åŠ è½½èœå•...').fontSize(14).fontColor('#999').margin({ top: 10 })
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        Row() {
          // 2.1 å·¦ä¾§åˆ†ç±»åˆ—è¡¨
          List() {
            ForEach(this.categoryList, (item: MenuCategory, index: number) => {
              ListItem() {
                Row() {
                  if (this.selectedIndex === index) {
                    Divider().vertical(true).strokeWidth(4).color('#0035AA').height(20).borderRadius(2)
                  }
                  Text(item.title)
                    .fontSize(14)
                    .fontColor(this.selectedIndex === index ? '#333' : '#666')
                    .fontWeight(this.selectedIndex === index ? FontWeight.Bold : FontWeight.Normal)
                    .layoutWeight(1)
                    .textAlign(TextAlign.Center)
                }
                .width('100%')
                .height(50)
                .backgroundColor(this.selectedIndex === index ? Color.White : '#F9F9F9')
                .onClick(() => {
                  this.selectedIndex = index;
                })
              }
            })
          }
          .width('25%')
          .height('100%')
          .backgroundColor('#F9F9F9')

          // 2.2 å³ä¾§å•†å“åˆ—è¡¨
          Column() {
            if (this.categoryList.length > 0) {
              Text(this.categoryList[this.selectedIndex].title)
                .fontSize(12)
                .fontColor('#333')
                .width('100%')
                .padding({ left: 10, top: 10, bottom: 10 })
                .backgroundColor(Color.White)
            }

            List() {
              if (this.categoryList.length > 0) {
                ForEach(this.categoryList[this.selectedIndex].goods, (goods: MenuItem) => {
                  ListItem() {
                    this.GoodsItemBuilder(goods)
                  }
                })
              }
            }
            .layoutWeight(1)
            .width('100%')
          }
          .width('75%')
          .height('100%')
          .backgroundColor(Color.White)
        }
        .layoutWeight(1)
        .width('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  @Builder GoodsItemBuilder(item: MenuItem) {
    Row() {
      // å›¾ç‰‡å ä½
      Stack({ alignContent: Alignment.TopStart }) {
        Column() {
          Text('â˜•').fontSize(30)
        }
        .width(80).height(80)
        .backgroundColor('#EEE')
        .justifyContent(FlexAlign.Center)
        .borderRadius(4)
      }
      .margin({ right: 10 })

      // å•†å“ä¿¡æ¯
      Column() {
        Text(item.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(item.description || 'æš‚æ— æè¿°')
          .fontSize(12)
          .fontColor('#999')
          .margin({ top: 2, bottom: 15 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(`Â¥${item.price}`)
            .fontSize(16)
            .fontColor('#D22028')
            .fontWeight(FontWeight.Bold)

          Text('âŠ•')
            .fontSize(24)
            .fontColor('#0035AA')
            .onClick(() => {
              console.info(`åŠ è´­: ${item.name}`);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .padding(10)
    .width('100%')
  }
}